<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Refund Hunter - FBA Reimbursement Audit Tool</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for a professional, data-focused app
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rh-primary': '#FE9900', // Amazon-inspired orange/gold for focus
                        'rh-dark': '#232f3e',    // Deep slate blue for text and background
                        'rh-success': '#4BB543', // Green for claims found
                        'rh-bg-light': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                },
            },
        }
    </script>
    
    <style>
        /* --- FIX: Define CSS variables explicitly for use in custom classes --- */
        :root {
            --rh-primary: #FE9900;
            --rh-success: #4BB543;
            --rh-dark: #232f3e;
        }
        /* Basic Font Setup */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light blue-gray background for subtle depth */
        }
        /* Custom Styles for Interactive Elements */
        .rh-primary-btn {
            background-color: var(--rh-primary);
            box-shadow: 0 4px 6px -1px rgba(254, 153, 0, 0.4); /* Added soft shadow to primary button */
            transition: all 0.2s ease-in-out;
        }
        .rh-primary-btn:hover:not(:disabled) {
            background-color: #e68a00; /* Slightly darker orange */
            transform: translateY(-1px);
        }
        /* Fix for the Single Audit button to have immediate color */
        .rh-secondary-btn {
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .rh-secondary-btn:hover:not(:disabled) {
            background-color: #2563eb; /* Blue-700 */
            transform: translateY(-1px);
        }
        /* End button fix */

        .rh-focus:focus {
            border-color: var(--rh-primary);
            box-shadow: 0 0 0 3px rgba(254, 153, 0, 0.3); /* Slightly thicker focus ring */
            outline: none;
        }
        /* Custom styles for the main card shadow */
        .main-card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), inset 0 0 10px rgba(0, 0, 0, 0.02);
        }
        /* Canvas height needs to be fixed for the chart drawing */
        #claim-chart {
            width: 100%;
            height: 250px;
        }
        /* Custom styles for JSON block */
        #claim-json-data {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- MAIN APPLICATION CONTAINER -->
    <div class="min-h-screen flex flex-col items-center p-4">
        <header class="text-center mb-10 w-full max-w-4xl pt-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-[var(--rh-dark)] tracking-tighter">
                <span class="text-[var(--rh-primary)]">Refund Hunter</span> | FBA Reimbursement Audit
            </h1>
            <p class="mt-3 text-lg text-slate-600">
                Stop losing money to Amazon's errors. Upload your Inventory Report and instantly generate a list of exact, actionable reimbursement claims.
            </p>
            <div id="status-message" class="mt-4 text-sm text-slate-500">Loading user data...</div>
            <div id="user-info" class="text-xs text-slate-400 mt-1 hidden">User ID: <span id="display-user-id"></span></div>
        </header>

        <!-- FILE UPLOAD AND ACTION AREA -->
        <main class="w-full max-w-2xl bg-white p-8 rounded-3xl main-card-shadow border border-gray-200">
            <div id="upload-section">
                <h2 class="text-2xl font-semibold mb-6 text-slate-800">1. Upload Your Amazon Report (.CSV)</h2>
                
                <!-- REPORT INSTRUCTIONS -->
                <div class="mt-4 mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
                    <h3 class="font-bold text-blue-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Where to find your report:
                    </h3>
                    <ul class="list-disc list-inside text-sm text-blue-700 mt-2 space-y-1">
                        <li>Go to **Amazon Seller Central** &rarr; Reports &rarr; Fulfillment.</li>
                        <li>Download the **Inventory Ledger Report** or **Daily Inventory History Report**.</li>
                        <li>Ensure the file format is **.CSV** and includes the full transaction history.</li>
                    </ul>
                </div>
                <!-- END REPORT INSTRUCTIONS -->

                <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-xl text-center hover:border-[var(--rh-primary)] transition duration-200">
                    <label for="csv-file" class="cursor-pointer block py-4">
                        <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4h-1"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-3-3m0 0l-3 3m3-3v8"/>
                        </svg>
                        <p class="mt-2 text-sm text-gray-600 font-medium" id="file-name-display">
                            Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)
                        </p>
                    </label>
                    <input type="file" id="csv-file" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                </div>

                <div class="flex items-center justify-between">
                    <button id="audit-button" class="rh-primary-btn px-8 py-3 text-white rounded-xl font-bold shadow-lg transition disabled:opacity-50" disabled>
                        Audit Report (Loading...)
                    </button>
                    <a href="#pricing" class="text-sm text-[var(--rh-primary)] hover:underline font-medium">See Pricing Plans</a>
                </div>

                <p class="text-xs text-gray-500 mt-4">Note: No raw data is stored. Your file content is sent directly to the AI for analysis.</p>
            </div>
            
            <!-- LOADING INDICATOR -->
            <div id="loading-indicator" class="hidden text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-[var(--rh-primary)] border-t-transparent mx-auto mb-4"></div>
                <p class="text-slate-700 font-medium">Analyzing over 10,000 lines of data... this may take a moment.</p>
            </div>
        </main>
        
        <!-- RESULTS DISPLAY AREA (Hidden by default, used for current audit) -->
        <section id="results-area" class="hidden w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200">
            <h2 class="text-3xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
                <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">0</span>
                Actionable Reimbursement Claims Found
            </h2>
            
            <!-- CHART VISUALIZATION AREA -->
            <div id="chart-container" class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
                <h3 class="text-xl font-semibold text-slate-800 mb-4">Claim Value Breakdown by Reason</h3>
                <canvas id="claim-chart"></canvas>
            </div>
            <!-- END CHART VISUALIZATION AREA -->
            
            <div id="claim-list" class="space-y-4">
                <!-- Claims will be inserted here, along with the File Claims button -->
            </div>
            <div id="no-claims-found" class="hidden bg-green-50 p-4 rounded-lg border border-green-200 mt-4">
                <p class="text-green-700 font-medium">Great news! Our audit found no immediate discrepancies requiring a claim in this report.</p>
            </div>
        </section>

        <!-- USER PROFILE/SETTINGS AREA (NEW) -->
        <section id="profile-area" class="w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200">
            <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Your Profile & Usage
            </h2>

            <div class="grid md:grid-cols-2 gap-6 mt-4">
                <!-- Usage Card -->
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                    <h3 class="font-semibold text-lg text-blue-800 mb-2">Audit Limits</h3>
                    <p class="text-4xl font-extrabold text-blue-600 mb-3" id="usage-display">
                        <span id="audits-used">0</span> / 5 <span class="text-base font-normal text-blue-500">Free Audits Used</span>
                    </p>
                    <div id="usage-progress" class="w-full bg-blue-200 rounded-full h-2.5">
                        <div id="usage-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-blue-700 mt-2">
                        <span id="audits-remaining">5</span> audits remaining before upgrade is suggested.
                    </p>
                </div>

                <!-- Subscription Card -->
                <div class="bg-white p-5 rounded-xl border border-gray-300 shadow">
                    <h3 class="font-semibold text-lg text-slate-800 mb-2">Subscription Status</h3>
                    <p class="text-xl font-bold text-gray-700" id="subscription-status">Trial User</p>
                    <p class="text-sm text-slate-500 mt-1 mb-4">
                        Current plan includes **5 free audits** for testing.
                    </p>
                    <button onclick="showUpgradeModal('audit_monthly')" class="rh-primary-btn px-4 py-2 text-sm text-white rounded-lg font-medium">
                        Manage Subscription / Upgrade
                    </button>
                </div>
            </div>
        </section>


        <!-- HISTORY DISPLAY AREA -->
        <section id="history-area" class="w-full max-w-4xl mt-10 p-6">
            <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4">Audit History</h2>
            <div id="history-list" class="space-y-4">
                <p id="history-loading" class="text-slate-500 italic">Loading previous audits...</p>
                <!-- Audit history items will be inserted here -->
            </div>
        </section>


        <!-- PRICING SECTION -->
        <section id="pricing" class="py-16 bg-white mt-10 w-full border-t border-gray-200">
            <div class="max-w-6xl mx-auto px-6 text-center">
                <h2 class="text-3xl font-bold mb-3 text-slate-900">Stop Leaving Money on the Table</h2>
                <p id="free-uses-display" class="text-xl text-slate-600 mb-12">Your first 5 audits are free.</p>

                <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                    
                    <!-- 1. Free Tier (Informational) -->
                    <div class="bg-gray-50 p-6 rounded-2xl border-2 border-gray-300 flex flex-col justify-between">
                        <div>
                            <p class="text-lg font-bold text-gray-700 mb-4">Trial Audit</p>
                            <p class="text-5xl font-extrabold text-slate-900 mb-2">FREE</p>
                            <p class="text-sm font-medium text-slate-500 mb-6">Limited to the first 5 reports</p>
                            <ul class="text-left space-y-3 text-sm text-slate-700">
                                <li class="flex items-center"><span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span> 5 Full-Report Audits</li>
                                <li class="flex items-center"><span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span> JSON/CSV Claim Export (Mock)</li>
                                <li class="flex items-center text-slate-400"><span class="text-red-500 mr-2 font-bold text-lg">&times;</span> Auto-Claim Filing</li>
                            </ul>
                        </div>
                        <button class="mt-8 w-full py-3 rounded-xl bg-gray-200 text-gray-500 font-bold cursor-default opacity-80" disabled>
                            Currently Active
                        </button>
                    </div>

                    <!-- 2. Pay Per Audit (Blue Button) -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-2 border-gray-300 flex flex-col justify-between hover:border-blue-400 transition">
                        <div>
                            <p class="text-lg font-bold text-slate-800 mb-4">Single Audit Boost</p>
                            <p class="text-5xl font-extrabold text-slate-900 mb-2">$99</p>
                            <p class="text-sm font-medium text-slate-500 mb-6">One-time purchase per report</p>
                            <ul class="text-left space-y-3 text-sm text-slate-700">
                                <li class="flex items-center"><span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span> 1 Full-Report Audit</li>
                                <li class="flex items-center"><span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span> JSON/CSV Claim Export (Mock)</li>
                                <li class="flex items-center text-slate-400"><span class="text-red-500 mr-2 font-bold text-lg">&times;</span> Auto-Claim Filing</li>
                            </ul>
                        </div>
                        <button onclick="showUpgradeModal('audit_single')" class="mt-8 w-full py-3 rounded-xl rh-secondary-btn font-bold">
                            Purchase Single Audit
                        </button>
                    </div>

                    <!-- 3. Pro Subscription (Orange Primary Button) -->
                    <div class="bg-white p-6 rounded-2xl shadow-2xl border-4 border-[var(--rh-primary)] scale-[1.05] flex flex-col justify-between">
                        <div class="absolute top-0 right-0 -mt-3 -mr-3 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full uppercase shadow-md">
                            Best Value
                        </div>
                        <div>
                            <p class="text-lg font-bold text-slate-800 mb-4">Pro Hunter Monthly</p>
                            <p class="text-5xl font-extrabold text-slate-900 mb-2">$199</p>
                            <p class="text-sm font-medium text-slate-500 mb-6">Billed Monthly for serious sellers</p>
                            <ul class="text-left space-y-3 text-sm text-slate-700">
                                <li class="flex items-center"><span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span> **Unlimited** Audits</li>
                                <li class="flex items-center"><span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span> JSON/CSV Claim Export (Mock)</li>
                                <li class="flex items-center"><span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span> Priority Support</li>
                            </ul>
                        </div>
                        <button onclick="showUpgradeModal('audit_monthly')" class="mt-8 rh-primary-btn w-full text-white p-3 rounded-xl font-bold transition">
                            Go Pro: Start Unlimited
                        </button>
                    </div>
                </div>
            </div>
        </section>


        <!-- FOOTER -->
        <footer class="py-8 bg-[var(--rh-dark)] text-center w-full text-slate-400 mt-10">
            <p>© 2025 Refund Hunter. Designed for FBA Sellers.</p>
        </footer>

        <!-- MODAL FOR UPGRADE/PAYMENT -->
        <div id="upgrade-modal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4 overflow-y-auto" onclick="closeModalOnOutsideClick(event)">
            <div class="bg-white p-8 rounded-2xl max-w-md w-full shadow-2xl my-10 relative" onclick="event.stopPropagation()">
                <button onclick="document.getElementById('upgrade-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
                
                <div class="text-center">
                    <svg id="modal-icon" class="h-12 w-12 text-[var(--rh-primary)] mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <!-- Placeholder icon, will be replaced by JS -->
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V4m0 16v-4m-6-3H4m16 0h-4"/></svg>
                    <h2 id="modal-title" class='text-2xl font-bold mb-2 text-[var(--rh-dark)]'>Upgrade Plan</h2>
                    <p id="modal-price" class='text-4xl font-extrabold text-[var(--rh-success)] mb-4'></p>
                    <p id="modal-description" class='text-slate-600 mb-6'></p>
                </div>
                
                <div class="space-y-3">
                    <a id="modal-checkout-link" target="_blank" class='rh-primary-btn w-full inline-block text-white p-3 rounded-xl font-semibold text-center transition'>
                        Secure Checkout & Unlock Audits
                    </a>
                    <button onclick="document.getElementById('upgrade-modal').classList.add('hidden')" class='w-full p-3 rounded-xl border border-slate-300 bg-gray-50 hover:bg-gray-100 transition font-medium'>
                        Cancel and Go Back
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL FOR CLAIM FILING PROCESS -->
        <div id="claim-filing-modal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-start z-50 p-4 overflow-y-auto" onclick="closeModalOnOutsideClick(event)">
            <div class="bg-white p-8 rounded-2xl max-w-3xl w-full shadow-2xl my-10 relative" onclick="event.stopPropagation()">
                <button onclick="document.getElementById('claim-filing-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
                
                <div class="text-center mb-6">
                    <h2 class='text-3xl font-bold mb-2 text-[var(--rh-dark)] flex items-center justify-center'>
                        <svg class="h-8 w-8 text-[var(--rh-success)] mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.27a8.68 8.68 0 00-4.088-3.957A8.68 8.68 0 0012 3a8.68 8.68 0 00-4.53 1.273A8.68 8.68 0 003.382 7.73 8.68 8.68 0 003 12a8.68 8.68 0 001.273 4.53 8.68 8.68 0 003.957 4.088A8.68 8.68 0 0012 21a8.68 8.68 0 004.53-1.273 8.68 8.68 0 004.088-3.957A8.68 8.68 0 0021 12a8.68 8.68 0 00-1.273-4.53z"/></svg>
                        Claim Filing Guide: Get Reimbursed
                    </h2>
                    <p class='text-xl text-slate-600'>You are about to file <span id="filing-claim-count" class="font-bold text-[var(--rh-primary)]"></span> claims worth <span id="filing-claim-value" class="font-bold text-[var(--rh-success)]"></span>.</p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Step 1: Claim Data -->
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">Step 1: Copy Claim Data (JSON)</h3>
                        <p class="text-sm text-slate-600 mb-2">Use this structured data to communicate the exact issue, SKU, and transaction ID to Amazon Support.</p>
                        
                        <div class="bg-gray-800 text-green-400 p-4 rounded-lg relative">
                            <pre id="claim-json-data" class="text-xs"></pre>
                            <button onclick="copyClaimData()" class="absolute top-2 right-2 p-2 bg-gray-700 rounded-lg text-white hover:bg-gray-600 transition text-xs font-medium">
                                <span id="copy-btn-text">Copy JSON</span>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Filing Instructions -->
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">Step 2: File on Seller Central</h3>
                        <ol class="list-decimal list-inside space-y-3 text-sm text-slate-700">
                            <li>Go to **Seller Central Help** &rarr; <a href="https://sellercentral.amazon.com/gp/contact-us/performance/ref=ag_contactus_foot_perfd_cont_201642190" target="_blank" class="text-blue-600 hover:underline font-medium">Contact Us</a> (Link opens in new tab).</li>
                            <li>Select "Selling on Amazon Issue" &rarr; "FBA Issue" &rarr; **"Investigate Missing or Damaged Units"**.</li>
                            <li>Paste the **Claim Data (JSON)** copied above directly into the support case description.</li>
                            <li>Attach the **original CSV report** you uploaded here as evidence.</li>
                            <li>Submit the case and track the reimbursements!</li>
                        </ol>
                    </div>
                </div>

                <button onclick="document.getElementById('claim-filing-modal').classList.add('hidden')" class='rh-primary-btn mt-8 w-full py-3 text-white rounded-xl font-bold shadow-lg transition'>
                    I Understand - Close Guide
                </button>
            </div>
        </div>


    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('debug'); // Uncomment to see Firebase logs

        // --- GLOBALS AND STATE ---
        const AUDIT_LIMIT = 5;
        let db, auth;
        let userId = null;
        let auditsUsed = 0;
        let isPremium = false; // New state variable
        let isAuthReady = false;
        let uploadedFileContent = null;
        let selectedFileName = "";
        let currentClaimsData = [];
        let currentTotalValue = 0;
        
        // Firebase Config and Auth Setup (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        function initFirebase() {
            try {
                // Log configuration details for debugging
                console.log("Firebase Init: App ID =", appId);
                console.log("Firebase Init: Config provided =", Object.keys(firebaseConfig).length > 0);
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("Firebase services initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('display-user-id').textContent = userId;
                        document.getElementById('user-info').classList.remove('hidden');
                        isAuthReady = true;
                        
                        console.log("Auth State Changed: Signed in as user:", userId);
                        // Load user data and history
                        loadUserDataAndHistory();
                    } else {
                        // Attempt sign-in if not authenticated
                        console.log("Auth State Changed: No user. Attempting sign-in...");
                        if (initialAuthToken) {
                            console.log("Attempting sign in with custom token.");
                            await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                console.error("Custom Token Sign-In Failed:", e);
                            });
                        } else {
                            console.log("Attempting anonymous sign in.");
                            await signInAnonymously(auth).catch(e => {
                                console.error("Anonymous Sign-In Failed:", e);
                            });
                        }
                    }
                    document.getElementById('status-message').textContent = "Awaiting file upload...";
                });

            } catch (error) {
                console.error("FIREBASE FATAL ERROR:", error);
                document.getElementById('status-message').textContent = "Error loading app. See console for details.";
            }
        }

        // --- FIRESTORE DATA MANAGEMENT ---

        // 1. Load User Limits and Audit History
        function loadUserDataAndHistory() {
            if (!db || !userId) return;
            console.log("Loading user data and history for user:", userId);

            // 1a. Listen to User Limits (for free uses count)
            const limitsDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/limits`);
            onSnapshot(limitsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    auditsUsed = data.auditsUsed || 0;
                    isPremium = data.isPremium || false;
                } else {
                    // Initialize if the document doesn't exist
                    console.log("Limits document not found, initializing to defaults.");
                    auditsUsed = 0;
                    isPremium = false;
                    setDoc(limitsDocRef, { auditsUsed: 0, isPremium: false }, { merge: true }).catch(console.error);
                }
                updateAuditButton();
                updateProfileDisplay(); // Update the new profile section
            }, (error) => {
                console.error("Error reading limits:", error);
                document.getElementById('status-message').textContent = "Error reading free uses limit.";
            });

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Refund Hunter - FBA Reimbursement Audit Tool</title>
    
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for a professional, data-focused app
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rh-primary': '#FE9900', // Amazon-inspired orange/gold for focus
                        'rh-dark': '#232f3e',    // Deep slate blue for text and background
                        'rh-success': '#4BB543', // Green for claims found
                        'rh-bg-light': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                },
            },
        }
    </script>
    
    <style>
        /* CSS variables for use in custom classes */
        :root {
            --rh-primary: #FE9900;
            --rh-success: #4BB543;
            --rh-dark: #232f3e;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light blue-gray background for subtle depth */
        }

        /* Primary CTA button */
        .rh-primary-btn {
            background-color: var(--rh-primary);
            box-shadow: 0 4px 6px -1px rgba(254, 153, 0, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .rh-primary-btn:hover:not(:disabled) {
            background-color: #e68a00;
            transform: translateY(-1px);
        }

        /* Secondary CTA button */
        .rh-secondary-btn {
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .rh-secondary-btn:hover:not(:disabled) {
            background-color: #2563eb; /* Blue-700 */
            transform: translateY(-1px);
        }

        .rh-focus:focus {
            border-color: var(--rh-primary);
            box-shadow: 0 0 0 3px rgba(254, 153, 0, 0.3);
            outline: none;
        }

        .main-card-shadow {
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 0 10px rgba(0, 0, 0, 0.02);
        }

        /* Canvas height for chart drawing */
        #claim-chart {
            width: 100%;
            height: 250px;
        }

        /* JSON display block */
        #claim-json-data {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="text-slate-800">

<!-- ======= PREMIUM SAAS NAVBAR ======= -->
<nav class="backdrop-blur-lg bg-white/70 border-b border-gray-200/60 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 lg:px-8 py-3 flex items-center justify-between">

        <!-- LEFT: LOGO + BRAND -->
        <div class="flex items-center space-x-3 group">
            <img
                src="https://raw.githubusercontent.com/theduckverse/RefundHunter/main/public/logo.jpg"
                alt="Refund Hunter Logo"
                class="h-10 w-auto transition-transform duration-300 group-hover:scale-105"
            />
            <div class="leading-tight">
                <span class="text-xl font-extrabold text-[var(--rh-dark)] tracking-tight flex items-center">
                    Refund Hunter
                    <span class="ml-2 h-2 w-2 bg-[var(--rh-primary)] rounded-full animate-pulse opacity-80"></span>
                </span>
                <span class="text-xs text-gray-500">Stop losing money to Amazon’s errors</span>
            </div>
        </div>

        <!-- CENTER LINKS -->
        <div class="hidden md:flex items-center space-x-10 font-medium">
            <a href="#upload-section" 
               class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Dashboard
            </a>
            <a href="#history-area" 
               class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                History
            </a>
            <a href="#pricing" 
               class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Pricing
            </a>
            <a href="#profile-area" 
               class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Account
            </a>
        </div>

        <!-- RIGHT: CTA BUTTON -->
        <button
            onclick="showUpgradeModal('audit_monthly')"
            class="px-5 py-2.5 rounded-xl font-semibold text-white shadow-lg 
                   bg-gradient-to-r from-[var(--rh-primary)] to-orange-500
                   hover:shadow-xl hover:scale-[1.03] transition-all duration-200">
            Upgrade
        </button>
    </div>
</nav>

<!-- MAIN APPLICATION CONTAINER -->
<div class="min-h-screen flex flex-col items-center p-4">
    <header class="text-center mb-10 w-full max-w-4xl pt-8">
        <h1 class="text-4xl md:text-5xl font-extrabold text-[var(--rh-dark)] tracking-tighter">
            <span class="text-[var(--rh-primary)]">Refund Hunter</span> | FBA Reimbursement Audit
        </h1>
        <p class="mt-3 text-lg text-slate-600">
            Stop losing money to Amazon's errors. Upload your Inventory Report and instantly generate a list of exact, actionable reimbursement claims.
        </p>
        <div id="status-message" class="mt-4 text-sm text-slate-500">Loading user data...</div>
        <div id="user-info" class="text-xs text-slate-400 mt-1 hidden">
            User ID: <span id="display-user-id"></span>
        </div>
    </header>

    <!-- FILE UPLOAD AND ACTION AREA -->
    <main class="w-full max-w-2xl bg-white p-8 rounded-3xl main-card-shadow border border-gray-200">
        <div id="upload-section">
            <h2 class="text-2xl font-semibold mb-6 text-slate-800">
                1. Upload Your Amazon Report (.CSV)
            </h2>
            
            <!-- REPORT INSTRUCTIONS -->
            <div class="mt-4 mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
                <h3 class="font-bold text-blue-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    Where to find your report:
                </h3>
                <ul class="list-disc list-inside text-sm text-blue-700 mt-2 space-y-1">
                    <li>Go to <strong>Amazon Seller Central</strong> → Reports → Fulfillment.</li>
                    <li>Download the <strong>Inventory Ledger Report</strong> or <strong>Daily Inventory History Report</strong>.</li>
                    <li>Ensure the file format is <strong>.CSV</strong> and includes the full transaction history.</li>
                </ul>
            </div>

            <!-- DRAG & DROP FILE AREA -->
            <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-xl text-center hover:border-[var(--rh-primary)] transition duration-200">
                <label for="csv-file" class="cursor-pointer block py-4">
                    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4h-1"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 15l-3-3m0 0l-3 3m3-3v8"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600 font-medium" id="file-name-display">
                        Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)
                    </p>
                </label>
                <input
                    type="file"
                    id="csv-file"
                    accept=".csv"
                    class="hidden"
                    onchange="handleFileSelect(event)"
                >
            </div>

            <div class="flex items-center justify-between">
                <button
                    id="audit-button"
                    class="rh-primary-btn px-8 py-3 text-white rounded-xl font-bold shadow-lg transition disabled:opacity-50"
                    disabled
                >
                    Audit Report (Loading...)
                </button>
                <a href="#pricing" class="text-sm text-[var(--rh-primary)] hover:underline font-medium">
                    See Pricing Plans
                </a>
            </div>

            <p class="text-xs text-gray-500 mt-4">
                Note: No raw data is stored. Your file content is sent directly to the AI for analysis.
            </p>
        </div>
        
        <!-- LOADING INDICATOR -->
        <div id="loading-indicator" class="hidden text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-[var(--rh-primary)] border-t-transparent mx-auto mb-4"></div>
            <p class="text-slate-700 font-medium">
                Analyzing over 10,000 lines of data... this may take a moment.
            </p>
        </div>
    </main>
    
    <!-- RESULTS DISPLAY AREA -->
    <section
        id="results-area"
        class="hidden w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-3xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">0</span>
            Actionable Reimbursement Claims Found
        </h2>
        
        <!-- CHART VISUALIZATION AREA -->
        <div id="chart-container" class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
            <h3 class="text-xl font-semibold text-slate-800 mb-4">
                Claim Value Breakdown by Reason
            </h3>
            <canvas id="claim-chart"></canvas>
        </div>
        
        <div id="claim-list" class="space-y-4">
            <!-- Claims + File Claims button injected via JS -->
        </div>

        <div
            id="no-claims-found"
            class="hidden bg-green-50 p-4 rounded-lg border border-green-200 mt-4"
        >
            <p class="text-green-700 font-medium">
                Great news! Our audit found no immediate discrepancies requiring a claim in this report.
            </p>
        </div>
    </section>

    <!-- PROFILE / USAGE SECTION -->
    <section
        id="profile-area"
        class="w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Your Profile & Usage
        </h2>

        <div class="grid md:grid-cols-2 gap-6 mt-4">
            <!-- Usage Card -->
            <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                <h3 class="font-semibold text-lg text-blue-800 mb-2">Audit Limits</h3>
                <p class="text-4xl font-extrabold text-blue-600 mb-3" id="usage-display">
                    <span id="audits-used">0</span> / 5
                    <span class="text-base font-normal text-blue-500">Free Audits Used</span>
                </p>
                <div id="usage-progress" class="w-full bg-blue-200 rounded-full h-2.5">
                    <div id="usage-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-sm text-blue-700 mt-2">
                    <span id="audits-remaining">5</span> audits remaining before upgrade is suggested.
                </p>
            </div>

            <!-- Subscription Card -->
            <div class="bg-white p-5 rounded-xl border border-gray-300 shadow">
                <h3 class="font-semibold text-lg text-slate-800 mb-2">Subscription Status</h3>
                <p class="text-xl font-bold text-gray-700" id="subscription-status">Trial User</p>
                <p class="text-sm text-slate-500 mt-1 mb-4">
                    Current plan includes <strong>5 free audits</strong> for testing.
                </p>
                <button
                    onclick="showUpgradeModal('audit_monthly')"
                    class="rh-primary-btn px-4 py-2 text-sm text-white rounded-lg font-medium"
                >
                    Manage Subscription / Upgrade
                </button>
            </div>
        </div>
    </section>

    <!-- HISTORY DISPLAY AREA -->
    <section id="history-area" class="w-full max-w-4xl mt-10 p-6">
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4">Audit History</h2>
        <div id="history-list" class="space-y-4">
            <p id="history-loading" class="text-slate-500 italic">
                Loading previous audits...
            </p>
        </div>
    </section>

    <!-- PRICING SECTION -->
    <section id="pricing" class="py-16 bg-white mt-10 w-full border-t border-gray-200">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold mb-3 text-slate-900">
                Stop Leaving Money on the Table
            </h2>
            <p id="free-uses-display" class="text-xl text-slate-600 mb-12">
                Your first 5 audits are free.
            </p>

            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <!-- 1. Free Tier -->
                <div class="bg-gray-50 p-6 rounded-2xl border-2 border-gray-300 flex flex-col justify-between">
                    <div>
                        <p class="text-lg font-bold text-gray-700 mb-4">Trial Audit</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">FREE</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            Limited to the first 5 reports
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                5 Full-Report Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>
                    <button
                        class="mt-8 w-full py-3 rounded-xl bg-gray-200 text-gray-500 font-bold cursor-default opacity-80"
                        disabled
                    >
                        Currently Active
                    </button>
                </div>

                <!-- 2. Pay Per Audit -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border-2 border-gray-300 flex flex-col justify-between hover:border-blue-400 transition">
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">Single Audit Boost</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$99</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            One-time purchase per report
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                1 Full-Report Audit
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>
                    <button
                        onclick="showUpgradeModal('audit_single')"
                        class="mt-8 w-full py-3 rounded-xl rh-secondary-btn font-bold"
                    >
                        Purchase Single Audit
                    </button>
                </div>

                <!-- 3. Pro Subscription -->
                <div class="relative bg-white p-6 rounded-2xl shadow-2xl border-4 border-[var(--rh-primary)] scale-[1.05] flex flex-col justify-between">
                    <div class="absolute top-0 right-0 -mt-3 -mr-3 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full uppercase shadow-md">
                        Best Value
                    </div>
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">Pro Hunter Monthly</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$199</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            Billed Monthly for serious sellers
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                <strong>Unlimited</strong> Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                Priority Support
                            </li>
                        </ul>
                    </div>
                    <button
                        onclick="showUpgradeModal('audit_monthly')"
                        class="mt-8 rh-primary-btn w-full text-white p-3 rounded-xl font-bold transition"
                    >
                        Go Pro: Start Unlimited
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer class="py-8 bg-[var(--rh-dark)] text-center w-full text-slate-400 mt-10">
        <p>© 2025 Refund Hunter. Designed for FBA Sellers.</p>
    </footer>

    <!-- UPGRADE / PAYMENT MODAL -->
    <div
        id="upgrade-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-md w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center">
                <svg
                    id="modal-icon"
                    class="h-12 w-12 text-[var(--rh-primary)] mx-auto mb-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <!-- Placeholder icon path will be replaced by JS -->
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V4m0 16v-4m-6-3H4m16 0h-4"/>
                </svg>
                <h2 id="modal-title" class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">
                    Upgrade Plan
                </h2>
                <p id="modal-price" class="text-4xl font-extrabold text-[var(--rh-success)] mb-4"></p>
                <p id="modal-description" class="text-slate-600 mb-6"></p>
            </div>
            
            <div class="space-y-3">
                <a
                    id="modal-checkout-link"
                    target="_blank"
                    class="rh-primary-btn w-full inline-block text-white p-3 rounded-xl font-semibold text-center transition"
                >
                    Secure Checkout & Unlock Audits
                </a>
                <button
                    onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                    class="w-full p-3 rounded-xl border border-slate-300 bg-gray-50 hover:bg-gray-100 transition font-medium"
                >
                    Cancel and Go Back
                </button>
            </div>
        </div>
    </div>

    <!-- CLAIM FILING MODAL -->
    <div
        id="claim-filing-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-start z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-3xl w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-2 text-[var(--rh-dark)] flex items-center justify-center">
                    <svg
                        class="h-8 w-8 text-[var(--rh-success)] mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9 12l2 2 4-4m5.618-4.27a8.68 8.68 0 00-4.088-3.957A8.68 8.68 0 0012 3a8.68 8.68 0 00-4.53 1.273A8.68 8.68 0 003.382 7.73 8.68 8.68 0 003 12a8.68 8.68 0 001.273 4.53 8.68 8.68 0 003.957 4.088A8.68 8.68 0 0012 21a8.68 8.68 0 004.53-1.273 8.68 8.68 0 004.088-3.957A8.68 8.68 0 0021 12a8.68 8.68 0 00-1.273-4.53z"/>
                    </svg>
                    Claim Filing Guide: Get Reimbursed
                </h2>
                <p class="text-xl text-slate-600">
                    You are about to file
                    <span id="filing-claim-count" class="font-bold text-[var(--rh-primary)]"></span>
                    claims worth
                    <span id="filing-claim-value" class="font-bold text-[var(--rh-success)]"></span>.
                </p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Step 1: Claim Data -->
                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 1: Copy Claim Data (JSON)
                    </h3>
                    <p class="text-sm text-slate-600 mb-2">
                        Use this structured data to communicate the exact issue, SKU, and transaction ID to Amazon Support.
                    </p>
                    
                    <div class="bg-gray-800 text-green-400 p-4 rounded-lg relative">
                        <pre id="claim-json-data" class="text-xs"></pre>
                        <button
                            onclick="copyClaimData()"
                            class="absolute top-2 right-2 p-2 bg-gray-700 rounded-lg text-white hover:bg-gray-600 transition text-xs font-medium"
                        >
                            <span id="copy-btn-text">Copy JSON</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Filing Instructions -->
                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 2: File on Seller Central
                    </h3>
                    <ol class="list-decimal list-inside space-y-3 text-sm text-slate-700">
                        <li>
                            Go to <strong>Seller Central Help</strong> →
                            <a
                                href="https://sellercentral.amazon.com/gp/contact-us/performance/ref=ag_contactus_foot_perfd_cont_201642190"
                                target="_blank"
                                class="text-blue-600 hover:underline font-medium"
                            >
                                Contact Us
                            </a>
                            (opens in a new tab).
                        </li>
                        <li>
                            Select "Selling on Amazon Issue" → "FBA Issue" →
                            <strong>"Investigate Missing or Damaged Units"</strong>.
                        </li>
                        <li>
                            Paste the <strong>Claim Data (JSON)</strong> you copied above directly into the case description.
                        </li>
                        <li>
                            Attach the <strong>original CSV report</strong> you uploaded here as evidence.
                        </li>
                        <li>
                            Submit the case and track the reimbursements.
                        </li>
                    </ol>
                </div>
            </div>

            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="rh-primary-btn mt-8 w-full py-3 text-white rounded-xl font-bold shadow-lg transition"
            >
                I Understand - Close Guide
            </button>
        </div>
    </div>
</div>

<!-- MAIN SCRIPT -->
<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        collection,
        query,
        orderBy,
        serverTimestamp,
        runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBALS AND STATE ---
    const AUDIT_LIMIT = 5;
    let db, auth;
    let userId = null;
    let auditsUsed = 0;
    let isPremium = false;
    let isAuthReady = false;
    let uploadedFileContent = null;
    let selectedFileName = "";
    let currentClaimsData = [];
    let currentTotalValue = 0;

    const API_BASE_URL = "https://refundhunter-backend.onrender.com";

    // These globals are injected by the host environment if present
    const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
    const firebaseConfig = JSON.parse(
        typeof __firebase_config !== "undefined" ? __firebase_config : "{}"
    );
    const initialAuthToken =
        typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;

    // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
    function initFirebase() {
        try {
            console.log("Firebase Init: App ID =", appId);
            console.log("Firebase Init: Config provided =", Object.keys(firebaseConfig).length > 0);

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            console.log("Firebase services initialized.");

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById("display-user-id").textContent = userId;
                    document.getElementById("user-info").classList.remove("hidden");
                    isAuthReady = true;

                    console.log("Auth State Changed: Signed in as user:", userId);

                    // Load user data and history
                    loadUserDataAndHistory();
                } else {
                    console.log("Auth State Changed: No user. Attempting sign-in...");
                    if (initialAuthToken) {
                        console.log("Attempting sign-in with custom token.");
                        await signInWithCustomToken(auth, initialAuthToken).catch((e) => {
                            console.error("Custom Token Sign-In Failed:", e);
                        });
                    } else {
                        console.log("Attempting anonymous sign-in.");
                        await signInAnonymously(auth).catch((e) => {
                            console.error("Anonymous Sign-In Failed:", e);
                        });
                    }
                }
                document.getElementById("status-message").textContent = "Awaiting file upload...";
            });
        } catch (error) {
            console.error("FIREBASE FATAL ERROR:", error);
            document.getElementById("status-message").textContent =
                "Error loading app. See console for details.";
        }
    }

    // --- FIRESTORE DATA MANAGEMENT ---

    // Load User Limits and Audit History
    function loadUserDataAndHistory() {
        if (!db || !userId) return;
        console.log("Loading user data and history for user:", userId);

        // Limits doc (usage + premium flag)
        const limitsDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/limits`);
        onSnapshot(
            limitsDocRef,
            (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    auditsUsed = data.auditsUsed || 0;
                    isPremium = data.isPremium || false;
                } else {
                    console.log("Limits document not found, initializing to defaults.");
                    auditsUsed = 0;
                    isPremium = false;
                    setDoc(
                        limitsDocRef,
                        { auditsUsed: 0, isPremium: false },
                        { merge: true }
                    ).catch(console.error);
                }
                updateAuditButton();
                updateProfileDisplay();
            },
            (error) => {
                console.error("Error reading limits:", error);
                document.getElementById("status-message").textContent =
                    "Error reading free uses limit.";
            }
        );

        // Audit history
        const historyCollectionRef = collection(
            db,
            `artifacts/${appId}/users/${userId}/audit_history`
        );
        const historyQuery = query(historyCollectionRef, orderBy("createdAt", "desc"));

        onSnapshot(
            historyQuery,
            (snapshot) => {
                console.log("History snapshot received. Documents:", snapshot.docs.length);
                renderHistory(snapshot.docs);
            },
            (error) => {
                console.error("Error reading history:", error);
                document.getElementById("history-loading").textContent =
                    "Error loading history.";
            }
        );
    }

    // Save an audit result to history
    async function saveAuditResult(fileName, claims, totalValue) {
        if (!db || !userId) return;

        try {
            const historyCollectionRef = collection(
                db,
                `artifacts/${appId}/users/${userId}/audit_history`
            );

            await setDoc(doc(historyCollectionRef), {
                fileName: fileName,
                claimsCount: claims.length,
                totalEstimatedValue: totalValue,
                claims: JSON.stringify(claims),
                createdAt: serverTimestamp()
            });

            console.log("Audit result saved successfully.");
        } catch (error) {
            console.error("Failed to save audit result:", error);
            document.getElementById("status-message").textContent =
                "Audit saved locally but failed to save to history.";
        }
    }

    // Increment the audit counter in a transaction
    async function incrementAuditCounter() {
        if (!db || !userId) return false;

        const limitsDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/limits`);

        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(limitsDocRef);
                if (!docSnap.exists()) {
                    transaction.set(limitsDocRef, { auditsUsed: 1, isPremium: false });
                    auditsUsed = 1;
                } else {
                    if (!docSnap.data().isPremium) {
                        const newCount = (docSnap.data().auditsUsed || 0) + 1;
                        transaction.update(limitsDocRef, { auditsUsed: newCount });
                        auditsUsed = newCount;
                    }
                }
            });

            updateAuditButton();
            updateProfileDisplay();
            return true;
        } catch (error) {
            console.error("Transaction failed (incrementAuditCounter):", error);
            document.getElementById("status-message").textContent =
                "Fatal Error: Failed to track usage.";
            return false;
        }
    }

    // --- RENDERING FUNCTIONS ---

    function renderHistory(docs) {
        const listContainer = document.getElementById("history-list");
        listContainer.innerHTML = "";
        document.getElementById("history-loading").classList.add("hidden");

        if (docs.length === 0) {
            listContainer.innerHTML =
                '<p class="text-slate-500 italic">No previous audits found. Upload your first report!</p>';
            return;
        }

        docs.forEach((docSnap) => {
            const data = docSnap.data();
            const date = data.createdAt
                ? new Date(data.createdAt.seconds * 1000).toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "short",
                      day: "numeric"
                  })
                : "N/A";

            const historyItem = document.createElement("div");
            historyItem.className =
                "bg-white p-4 rounded-xl shadow border border-gray-200 flex justify-between items-center hover:shadow-lg transition cursor-pointer";
            historyItem.onclick = () => viewHistoryItem(docSnap.id);

            historyItem.innerHTML = `
                <div>
                    <p class="font-semibold text-slate-800">${data.fileName || "Audit Report"}</p>
                    <p class="text-sm text-slate-600">
                        Audited on ${date} &bull; ${data.claimsCount} claims found
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-extrabold text-[var(--rh-success)]">
                        $${(data.totalEstimatedValue || 0).toFixed(2)}
                    </p>
                    <span class="text-xs text-[var(--rh-primary)] hover:underline mt-1">
                        View Details
                    </span>
                </div>
            `;
            listContainer.appendChild(historyItem);
        });
    }

    // View a single history item
    window.viewHistoryItem = function (docId) {
        const docRef = doc(
            db,
            `artifacts/${appId}/users/${userId}/audit_history/${docId}`
        );

        onSnapshot(
            docRef,
            (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const claims = JSON.parse(data.claims || "[]");

                    currentClaimsData = claims;
                    currentTotalValue = data.totalEstimatedValue || 0;

                    displayClaims(claims, data.totalEstimatedValue || 0, data.fileName);
                }
            },
            (error) => {
                console.error("Failed to load history item:", error);
                document.getElementById("status-message").textContent =
                    "Failed to load audit details.";
            }
        );
    };

    // --- FILE HANDLING ---

    window.handleFileSelect = function (event) {
        const file = event.target.files[0];
        const auditButton = document.getElementById("audit-button");
        const fileNameDisplay = document.getElementById("file-name-display");

        document.getElementById("results-area").classList.add("hidden");

        if (file) {
            if (file.type !== "text/csv" && !file.name.endsWith(".csv")) {
                fileNameDisplay.textContent = "Error: Please upload a .csv file only.";
                fileNameDisplay.classList.add("text-red-500");
                auditButton.disabled = true;
                return;
            }

            selectedFileName = file.name;
            fileNameDisplay.textContent = `File Selected: ${selectedFileName}`;
            fileNameDisplay.classList.remove("text-red-500");

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileContent = e.target.result;
                updateAuditButton();
            };
            reader.onerror = () => {
                fileNameDisplay.textContent = "Error reading file.";
                fileNameDisplay.classList.add("text-red-500");
                uploadedFileContent = null;
                updateAuditButton();
            };
            reader.readAsText(file);
        } else {
            fileNameDisplay.textContent =
                "Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)";
            uploadedFileContent = null;
            updateAuditButton();
        }
    };

    // --- UI UPDATES ---

    function updateProfileDisplay() {
        const auditsUsedEl = document.getElementById("audits-used");
        const auditsRemainingEl = document.getElementById("audits-remaining");
        const usageBarEl = document.getElementById("usage-bar");
        const subscriptionStatusEl = document.getElementById("subscription-status");

        const remaining = AUDIT_LIMIT - auditsUsed;
        const progress = isPremium ? 100 : (auditsUsed / AUDIT_LIMIT) * 100;

        auditsUsedEl.textContent = auditsUsed;
        auditsRemainingEl.textContent = remaining;
        usageBarEl.style.width = `${progress}%`;

        if (isPremium) {
            subscriptionStatusEl.textContent = "PRO Hunter (Unlimited)";
            subscriptionStatusEl.classList.remove("text-gray-700");
            subscriptionStatusEl.classList.add("text-[var(--rh-success)]");
            document.getElementById("usage-display").innerHTML = `
                <span id="audits-used">${auditsUsed}</span>
                <span class="text-base font-normal text-blue-500">
                    Audits Completed (Unlimited Plan)
                </span>
            `;
            document.getElementById("usage-bar").classList.add("bg-[var(--rh-success)]");
        } else {
            subscriptionStatusEl.textContent = "Trial User";
            subscriptionStatusEl.classList.remove("text-[var(--rh-success)]");
            subscriptionStatusEl.classList.add("text-gray-700");
            document.getElementById("usage-display").innerHTML = `
                <span id="audits-used">${auditsUsed}</span> / ${AUDIT_LIMIT}
                <span class="text-base font-normal text-blue-500">
                    Free Audits Used
                </span>
            `;
            document.getElementById("usage-bar").classList.remove("bg-[var(--rh-success)]");
        }
    }

    function updateAuditButton() {
        const auditButton = document.getElementById("audit-button");
        const freeUsesDisplay = document.getElementById("free-uses-display");
        const remaining = AUDIT_LIMIT - auditsUsed;
        const isFileReady = uploadedFileContent !== null;

        // Clean and reset click handler
        auditButton.onclick = null;

        if (isPremium || remaining > 0) {
            if (isPremium) {
                auditButton.textContent = "Run Audit (PRO Unlimited)";
                freeUsesDisplay.innerHTML =
                    'You are a <strong>PRO Hunter</strong>. Unlimited audits unlocked!';
            } else {
                auditButton.textContent = `Audit Report (${remaining}/${AUDIT_LIMIT} FREE Uses Remaining)`;
                freeUsesDisplay.innerHTML = `
                    Your <strong>first ${AUDIT_LIMIT} audits are free</strong>.
                    You have <strong>${remaining}</strong> left.
                `;
            }

            auditButton.disabled = !isFileReady;
            if (isFileReady) {
                auditButton.onclick = processAuditWrapper;
            }
        } else {
            auditButton.textContent = "Audit Report (Upgrade Required)";
            freeUsesDisplay.innerHTML = `
                You have used your <strong>${AUDIT_LIMIT} free audits</strong>.
                Please upgrade below for unlimited use.
            `;

            if (isFileReady) {
                auditButton.disabled = false;
                auditButton.onclick = () => showUpgradeModal("audit_monthly");
            } else {
                auditButton.disabled = true;
            }
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        initFirebase();
        // Initial hookup; updateAuditButton will override as needed
        const auditButton = document.getElementById("audit-button");
        if (auditButton) {
            auditButton.onclick = processAuditWrapper;
        }
    });

    // Wrapper for checking limits before audit
    function processAuditWrapper() {
        if (!isPremium && auditsUsed >= AUDIT_LIMIT) {
            showUpgradeModal("audit_monthly");
            return;
        }
        if (uploadedFileContent) {
            processAudit(uploadedFileContent, selectedFileName);
        }
    }

    function finishAuditDisplay() {
        document.getElementById("loading-indicator").classList.add("hidden");
        document.getElementById("upload-section").classList.remove("hidden");

        displayClaims(currentClaimsData, currentTotalValue, selectedFileName);

        uploadedFileContent = null;
        selectedFileName = "";
        document.getElementById("file-name-display").textContent =
            "Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)";
        document.getElementById("csv-file").value = "";
        document.getElementById("audit-button").disabled = true;

        document.getElementById("status-message").textContent =
            "Audit Complete. Ready for next report.";
    }

    // --- MODALS / PAYMENT ---

    window.closeModalOnOutsideClick = function (event) {
        if (event.target.id === "upgrade-modal" || event.target.id === "claim-filing-modal") {
            document.getElementById("upgrade-modal").classList.add("hidden");
            document.getElementById("claim-filing-modal").classList.add("hidden");
        }
    };

    window.showUpgradeModal = function (productName) {
        const modal = document.getElementById("upgrade-modal");
        const title = document.getElementById("modal-title");
        const price = document.getElementById("modal-price");
        const description = document.getElementById("modal-description");
        const checkoutLink = document.getElementById("modal-checkout-link");
        const modalIconPath = modal.querySelector("#modal-icon path");

        const currentUserId = userId || "anonymous";

        const productDetails =
            {
                audit_monthly: {
                    title: "Unlock Unlimited Audits",
                    price: "$199 / Month",
                    description:
                        "Go Pro and get unlimited access to Refund Hunter. Never miss a claim again.",
                    iconPath:
                        "M12 1c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zM10 13l2-2 2 2M10 11l2-2 2 2",
                    url: `https://mock-secure-checkout.com/pro-plan?uid=${currentUserId}`
                },
                audit_single: {
                    title: "Purchase Single Audit Boost",
                    price: "$99 One-Time",
                    description:
                        "Purchase a single audit report immediately. Great for occasional use or one large report.",
                    iconPath: "M12 6v6m0 0v6m0-6h6m-6 0H6",
                    url: `https://mock-secure-checkout.com/single-audit?uid=${currentUserId}`
                }
            }[productName] || null;

        if (!productDetails) return;

        title.textContent = productDetails.title;
        price.textContent = productDetails.price;
        description.textContent = productDetails.description;
        checkoutLink.href = productDetails.url;

        if (modalIconPath) {
            modalIconPath.setAttribute("d", productDetails.iconPath);
        }

        modal.classList.remove("hidden");
    };

    // --- CLAIM FILING MODAL ---

    window.showClaimFilingModal = function (claims, totalValue) {
        const modal = document.getElementById("claim-filing-modal");
        const claimCountDisplay = document.getElementById("filing-claim-count");
        const claimValueDisplay = document.getElementById("filing-claim-value");
        const jsonDataBlock = document.getElementById("claim-json-data");
        const copyBtnText = document.getElementById("copy-btn-text");

        claimCountDisplay.textContent = `${claims.length}`;
        claimValueDisplay.textContent = `$${totalValue.toFixed(2)}`;

        const jsonClaims = JSON.stringify(claims, null, 2);
        jsonDataBlock.textContent = jsonClaims;

        copyBtnText.textContent = "Copy JSON";
        modal.classList.remove("hidden");
    };

    window.copyClaimData = function () {
        const jsonDataBlock = document.getElementById("claim-json-data");
        const copyBtnText = document.getElementById("copy-btn-text");

        try {
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = jsonDataBlock.textContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand("copy");
            document.body.removeChild(tempTextArea);

            copyBtnText.textContent = "Copied!";
            setTimeout(() => {
                copyBtnText.textContent = "Copy JSON";
            }, 2000);
        } catch (err) {
            console.error("Failed to copy text: ", err);
            copyBtnText.textContent = "Error Copying!";
        }
    };

    // --- AI GENERATION / BACKEND CALL ---

    async function processAudit(csvContent, fileName) {
        if (!isPremium && auditsUsed >= AUDIT_LIMIT) {
            showUpgradeModal("audit_monthly");
            return;
        }

        document.getElementById("upload-section").classList.add("hidden");
        document.getElementById("loading-indicator").classList.remove("hidden");
        document.getElementById("results-area").classList.add("hidden");
        document.getElementById("status-message").textContent =
            `Analyzing ${fileName}...`;

        try {
            const response = await fetch(`${API_BASE_URL}/api/audit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    csvContent,
                    fileName,
                    userId: userId || "anonymous"
                })
            });

            if (!response.ok) {
                throw new Error(`Backend responded with status ${response.status}`);
            }

            const data = await response.json();

            currentClaimsData = data.claims || [];
            currentTotalValue = data.totalEstimatedValue || 0;

            if (!isPremium) {
                await incrementAuditCounter();
            }
            await saveAuditResult(fileName, currentClaimsData, currentTotalValue);
        } catch (err) {
            console.error("BACKEND ERROR:", err);
            alert("Error analyzing your report. Please try again.");

            currentClaimsData = [];
            currentTotalValue = 0;

            document.getElementById("loading-indicator").classList.add("hidden");
            document.getElementById("upload-section").classList.remove("hidden");
            document.getElementById("status-message").textContent =
                "Audit Failed: Connection or server error.";
            return;
        }

        finishAuditDisplay();
    }

    // --- CHART RENDERING ---

    let lastClaimsData = null;

    function renderClaimChart(data, total) {
        const canvas = document.getElementById("claim-chart");
        const ctx = canvas.getContext("2d");

        lastClaimsData = { data, total };

        canvas.width = canvas.offsetWidth;
        canvas.height = 250;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (total === 0 || !Object.keys(data).length) {
            ctx.fillStyle = "#94a3b8"; // slate-400
            ctx.font = "16px Inter";
            ctx.textAlign = "center";
            ctx.fillText("No claims found to chart.", canvas.width / 2, canvas.height / 2);
            return;
        }

        const reasons = Object.keys(data);
        const values = Object.values(data);
        const numBars = reasons.length;

        const colors = ["#FE9900", "#4BB543", "#3498DB", "#E74C3C", "#9B59B6", "#F39C12"];
        const darkText = "#1f2937";
        const lightGrey = "#e5e7eb";

        const padding = 30;
        const chartHeight = canvas.height - padding * 2;
        const chartWidth = canvas.width - padding * 2;
        const barSpacing = 15;
        const barWidth = (chartWidth - (numBars - 1) * barSpacing) / numBars;
        const maxValue = Math.max(...values) * 1.1;

        ctx.strokeStyle = lightGrey;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, canvas.height - padding);
        ctx.lineTo(canvas.width - padding, canvas.height - padding);
        ctx.stroke();

        for (let i = 0; i < numBars; i++) {
            const value = values[i];
            const reason = reasons[i];
            const x = padding + i * (barWidth + barSpacing);
            const barHeight = (value / maxValue) * chartHeight;
            const y = canvas.height - padding - barHeight;
            const barXCenter = x + barWidth / 2;

            ctx.fillStyle = colors[i % colors.length];
            ctx.fillRect(x, y, barWidth, barHeight);

            ctx.fillStyle = darkText;
            ctx.font = "11px Inter";
            ctx.textAlign = "center";
            ctx.fillText(reason, barXCenter, canvas.height - 10);

            ctx.fillStyle = darkText;
            ctx.font = "14px Inter bold";
            ctx.fillText(`$${value.toFixed(0)}`, barXCenter, y - 5);
        }
    }

    window.addEventListener("resize", () => {
        const resultsArea = document.getElementById("results-area");
        if (!resultsArea.classList.contains("hidden") && lastClaimsData) {
            renderClaimChart(lastClaimsData.data, lastClaimsData.total);
        }
    });

    function displayClaims(claims, totalEstimatedValue, auditFileName) {
        const resultsArea = document.getElementById("results-area");
        const listContainer = document.getElementById("claim-list");
        const claimCountDisplay = document.getElementById("claim-count");
        const noClaimsMessage = document.getElementById("no-claims-found");

        resultsArea.classList.remove("hidden");
        resultsArea.querySelector("h2").innerHTML = `
            <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">
                ${claims.length}
            </span>
            Actionable Reimbursement Claims Found in: ${auditFileName}
        `;

        listContainer.innerHTML = "";
        const valueByReason = {};

        if (claims && claims.length > 0) {
            claimCountDisplay.textContent = claims.length;
            noClaimsMessage.classList.add("hidden");

            claims.forEach((claim) => {
                const value = parseFloat(claim.estimatedValue) || 0;
                const reason = claim.claimReason || "Unspecified Claim";

                valueByReason[reason] = (valueByReason[reason] || 0) + value;

                const claimElement = document.createElement("div");
                claimElement.className =
                    "bg-gray-50 p-4 rounded-xl border border-gray-200 hover:bg-gray-100 transition";
                claimElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-bold text-slate-800">${reason}</span>
                        <span class="text-xl font-extrabold text-[var(--rh-success)]">
                            $${value.toFixed(2)}
                        </span>
                    </div>
                    <p class="text-sm text-slate-600">
                        <strong>SKU:</strong> ${claim.sku || "N/A"} &bull;
                        <strong>Qty:</strong> ${claim.quantity || 1} &bull;
                        <strong>Ref ID:</strong> ${claim.amazonTransactionId || "None"}
                    </p>
                `;
                listContainer.appendChild(claimElement);
            });

            renderClaimChart(valueByReason, totalEstimatedValue);

            const summaryElement = document.createElement("div");
            summaryElement.className =
                "bg-white p-6 rounded-xl border-4 border-[var(--rh-primary)] shadow-inner mb-6";
            summaryElement.innerHTML = `
                <p class="text-xl font-bold text-[var(--rh-dark)] flex justify-between">
                    <span>Total Estimated Reimbursement Value:</span> 
                    <span class="text-3xl text-[var(--rh-success)] font-extrabold">
                        $${totalEstimatedValue.toFixed(2)}
                    </span>
                </p>
                <p class="text-sm text-slate-500 mt-2">
                    This is the cash you can claim back by filing these reports.
                </p>
            `;
            listContainer.prepend(summaryElement);

            const fileClaimsButton = document.createElement("button");
            fileClaimsButton.id = "file-claims-btn";
            fileClaimsButton.className =
                "rh-primary-btn mt-6 w-full py-3 text-white rounded-xl font-bold shadow-lg transition";
            fileClaimsButton.textContent = `File ${claims.length} Claims Worth $${totalEstimatedValue.toFixed(2)}`;
            fileClaimsButton.onclick = () =>
                showClaimFilingModal(currentClaimsData, currentTotalValue);

            listContainer.appendChild(fileClaimsButton);
        } else {
            claimCountDisplay.textContent = "0";
            noClaimsMessage.classList.remove("hidden");
            renderClaimChart({}, 0);
        }
    }
</script>
</body>
</html>
<!-- force pages rebuild -->
