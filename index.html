<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FBA Money Scout - FBA Reimbursement Audit Tool</title>
    
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for the chart visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rh-primary': '#FE9900',
                        'rh-dark': '#232f3e',
                        'rh-success': '#4BB543',
                        'rh-bg-light': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                },
            },
        }
    </script>

    <style>
        :root {
            --rh-primary: #FE9900;
            --rh-success: #4BB543;
            --rh-dark: #232f3e;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .rh-primary-btn {
            background-color: var(--rh-primary);
            box-shadow: 0 4px 6px -1px rgba(254, 153, 0, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .rh-primary-btn:hover:not(:disabled) {
            background-color: #e68a00;
            transform: translateY(-1px);
        }

        .rh-secondary-btn {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .rh-secondary-btn:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        .rh-focus:focus {
            border-color: var(--rh-primary);
            box-shadow: 0 0 0 3px rgba(254, 153, 0, 0.3);
            outline: none;
        }

        .main-card-shadow {
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 0 10px rgba(0, 0, 0, 0.02);
        }

        #claim-chart {
            width: 100%;
            height: 250px;
        }

        #claim-json-data {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="text-slate-800">

<!-- ======= NAVBAR ======= -->
<nav class="backdrop-blur-lg bg-white/70 border-b border-gray-200/60 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex flex-col leading-tight">
            <span class="text-2xl font-extrabold text-[var(--rh-dark)] tracking-tight">
                FBA Money Scout
                <span class="ml-2 h-2 w-2 bg-[var(--rh-primary)] rounded-full inline-block opacity-80"></span>
            </span>
            <span class="text-xs text-gray-500">Stop losing money to Amazon’s errors</span>
        </div>

        <div class="hidden md:flex items-center space-x-10 font-medium">
            <a href="#upload-section" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Dashboard
            </a>
            <a href="#history-area" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                History
            </a>
            <a href="#pricing" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Pricing
            </a>
            <a href="#profile-area" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Account
            </a>
        </div>

        <div class="flex items-center space-x-4">
            <button id="nav-login-btn"
                    class="text-[var(--rh-primary)] font-semibold hover:underline"
                    onclick="openLoginModal()">
                Log In
            </button>
            <button id="nav-logout-btn"
                    class="hidden text-gray-600 font-semibold hover:underline"
                    onclick="logoutUser()">
                Log Out
            </button>
            <button
                onclick="document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' })"
                class="bg-gradient-to-r from-orange-400 to-orange-600 text-white px-4 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                Upgrade
            </button>
        </div>
    </div>
</nav>
<!-- HERO SECTION -->
<section class="w-full bg-white py-16 px-4 md:px-10 border-b border-gray-100">
  <div class="max-w-6xl mx-auto text-center">
    <h1 class="text-4xl md:text-6xl font-extrabold text-[var(--rh-dark)] leading-tight">
      <span class="text-[var(--rh-primary)]">FBA Money Scout</span>
      <span class="text-[var(--rh-dark)]"> | FBA Reimbursement Audit</span>
    </h1>
    <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">
      Stop losing money to Amazon’s errors. Upload your Inventory Report and instantly generate
      a list of exact, actionable reimbursement claims.
    </p>
  </div>
</section>

<!-- MAIN APPLICATION CONTAINER -->
<div class="min-h-screen flex flex-col items-center p-4">
    <!-- FILE UPLOAD AND ACTION AREA -->
    <main class="w-full max-w-2xl bg-white p-8 rounded-xl mt-10 main-card-shadow border border-gray-200">
        <div id="upload-section">
            <h2 class="text-2xl font-semibold mb-6 text-slate-800">
                1. Upload Your Amazon Report (.CSV)
            </h2>
            <p id="status-message" class="text-sm text-gray-500 mb-4">You must be logged in to audit a report.</p>

            <div class="mt-4 mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
                <h3 class="font-bold text-blue-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    Where to find your report:
                </h3>
                <ul class="list-disc list-inside text-sm text-blue-700 mt-2 space-y-1">
                    <li>Go to <strong>Amazon Seller Central</strong> → Reports → Fulfillment.</li>
                    <li>Download the <strong>Inventory Ledger Report</strong> or <strong>Daily Inventory History Report</strong>.</li>
                    <li>Ensure the file format is <strong>.CSV</strong> and includes the full transaction history.</li>
                </ul>
            </div>

            <!-- DRAG & DROP FILE AREA -->
            <div id="file-drop-area" class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-xl text-center hover:border-[var(--rh-primary)] transition duration-200">
                <label for="csv-file" class="cursor-pointer block py-4">
                    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4h-1"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 15l-3-3m0 0l-3 3m3-3v8"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600 font-medium" id="file-name-display">
                        Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)
                    </p>
                </label>
                <input 
                    type="file"
                    id="csv-file"
                    accept=".csv"
                    class="hidden"
                    onchange="requireLoginThenSelectFile(event)"
                />
            </div>

            <div class="flex items-center justify-between">
                <button
                    id="audit-button"
                    onclick="runAudit()"
                    class="rh-primary-btn px-8 py-3 text-white rounded-xl font-bold shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Audit Report
                </button>
                <a href="#pricing" class="text-sm text-[var(--rh-primary)] hover:underline font-medium">
                    See Pricing Plans
                </a>
            </div>

            <p class="text-xs text-gray-500 mt-4">
                Note: No raw data is stored. Your file content is sent directly to the AI for analysis.
            </p>
        </div>
        
        <div id="loading-indicator" class="hidden text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-[var(--rh-primary)] border-t-transparent mx-auto mb-4"></div>
            <p class="text-slate-700 font-medium">
                Analyzing over 10,000 lines of data... this may take a moment.
            </p>
        </div>
    </main>
    
    <!-- RESULTS DISPLAY AREA -->
    <section
        id="results-area"
        class="hidden w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-3xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">0</span>
            Actionable Reimbursement Claims Found
        </h2>
        <div class="flex justify-between items-center mb-6">
             <button
                onclick="openClaimFilingModal()"
                id="file-claims-btn"
                class="rh-primary-btn px-6 py-3 text-white rounded-xl font-bold shadow-lg transition"
            >
                File Claims on Seller Central
            </button>
            <p class="text-lg font-semibold text-slate-700">
                Potential Value: <span id="total-value-display" class="text-green-600 font-extrabold">$0.00</span>
            </p>
        </div>
        
        <div id="chart-container" class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
            <h3 class="text-xl font-semibold text-slate-800 mb-4">
                Claim Value Breakdown by Reason
            </h3>
            <canvas id="claim-chart"></canvas>
        </div>
        
        <h3 class="text-2xl font-semibold text-slate-800 mb-4 border-b pb-2">Individual Claim Details</h3>
        <div id="claim-list" class="space-y-4"></div>

        <div
            id="no-claims-found"
            class="hidden bg-green-50 p-4 rounded-lg border border-green-200 mt-4"
        >
            <p class="text-green-700 font-medium">
                Great news! Our audit found no immediate discrepancies requiring a claim in this report.
            </p>
        </div>
    </section>

    <!-- PROFILE / USAGE SECTION -->
    <section
        id="profile-area"
        class="w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Your Profile & Usage
        </h2>

        <div class="grid md:grid-cols-2 gap-6 mt-4">
            <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                <h3 class="font-semibold text-lg text-blue-800 mb-2">Audit Limits</h3>
                <p class="text-4xl font-extrabold text-blue-600 mb-3" id="usage-display">
                    <span id="audits-used">0</span> / 5
                    <span class="text-base font-normal text-blue-500">Free Audits Used</span>
                </p>
                <div id="usage-progress" class="w-full bg-blue-200 rounded-full h-2.5">
                    <div id="usage-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-sm text-blue-700 mt-2">
                    <span id="audits-remaining">5</span> audits remaining before upgrade is suggested.
                </p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-gray-300 shadow">
                <h3 class="font-semibold text-lg text-slate-800 mb-2">Subscription Status</h3>
                <p class="text-xl font-bold text-gray-700" id="subscription-status">Trial User</p>
                <p class="text-sm text-slate-500 mt-1 mb-4">
                    Current plan includes <strong>5 free audits</strong> for testing.
                </p>
                <button
                    onclick="showUpgradeModal('audit_monthly')"
                    class="rh-primary-btn px-4 py-2 text-sm text-white rounded-lg font-medium"
                >
                    Manage Subscription / Upgrade
                </button>
            </div>
        </div>
    </section>

    <!-- HISTORY DISPLAY AREA -->
    <section id="history-area" class="w-full max-w-4xl mt-10 p-6">
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4">Audit History</h2>
        <div id="history-list" class="space-y-4">
            <p id="history-loading" class="text-slate-500 italic">
                You must be logged in to view history.
            </p>
        </div>
    </section>

    <!-- PRICING SECTION -->
    <section id="pricing" class="py-16 bg-white mt-10 w-full border-t border-gray-200">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold mb-3 text-slate-900">
                Stop Leaving Money on the Table
            </h2>
            <p id="free-uses-display" class="text-xl text-slate-600 mb-12">
                Your first 5 audits are free.
            </p>

            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <div class="bg-gray-50 p-6 rounded-2xl border-2 border-gray-300 flex flex-col justify-between">
                    <div>
                        <p class="text-lg font-bold text-gray-700 mb-4">Trial Audit</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">FREE</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            Limited to the first 5 reports
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                5 Full-Report Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>
                    <button
                        class="mt-8 w-full py-3 rounded-xl bg-gray-200 text-gray-500 font-bold cursor-default opacity-80"
                        disabled
                    >
                        Currently Active
                    </button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-xl border-2 border-gray-300 flex flex-col justify-between hover:border-blue-400 transition">
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">Single Audit Boost</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$99</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            One-time purchase per report
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                1 Full-Report Audit
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>
                    <button
                        onclick="showUpgradeModal('audit_single')"
                        class="mt-8 w-full py-3 rounded-xl rh-secondary-btn font-bold"
                    >
                        Purchase Single Audit
                    </button>
                </div>

                <div class="relative bg-white p-6 rounded-2xl shadow-2xl border-4 border-[var(--rh-primary)] scale-[1.05] flex flex-col justify-between">
                    <div class="absolute top-0 right-0 -mt-3 -mr-3 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full uppercase shadow-md">
                        Best Value
                    </div>
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">Pro Hunter Monthly</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$199</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            Billed Monthly for serious sellers
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                <strong>Unlimited</strong> Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                Priority Support
                            </li>
                        </ul>
                    </div>
                    <button
                        onclick="showUpgradeModal('audit_monthly')"
                        class="mt-8 rh-primary-btn w-full text-white p-3 rounded-xl font-bold transition"
                    >
                        Go Pro: Start Unlimited
                    </button>
                </div>
            </div>
        </div>
    </section>
    
    <footer class="py-8 bg-[var(--rh-dark)] text-center w-full text-slate-400 mt-10">
        <p>© 2025 FBA Money Scout. Designed for FBA Sellers.</p>
    </footer>

    <!-- UPGRADE MODAL -->
    <div
        id="upgrade-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-md w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center">
                <svg
                    id="modal-icon"
                    class="h-12 w-12 text-[var(--rh-primary)] mx-auto mb-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V4m0 16v-4m-6-3H4m16 0h-4"/>
                </svg>
                <h2 id="modal-title" class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">
                    Upgrade Plan
                </h2>
                <p id="modal-price" class="text-4xl font-extrabold text-[var(--rh-success)] mb-4"></p>
                <p id="modal-description" class="text-slate-600 mb-6"></p>
            </div>
            
            <div class="space-y-3">
                <a
                    id="modal-checkout-link"
                    target="_blank"
                    href="#"
                    class="rh-primary-btn w-full inline-block text-white p-3 rounded-xl font-semibold text-center transition"
                >
                    Secure Checkout & Unlock Audits
                </a>
                <button
                    onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                    class="w-full p-3 rounded-xl border border-slate-300 bg-gray-50 hover:bg-gray-100 transition font-medium"
                >
                    Cancel and Go Back
                </button>
            </div>
        </div>
    </div>

    <!-- CLAIM FILING MODAL -->
    <div
        id="claim-filing-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-start z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-3xl w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-2 text-[var(--rh-dark)] flex items-center justify-center">
                    <svg
                        class="h-8 w-8 text-[var(--rh-success)] mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9 12l2 2 4-4m5.618-4.27a8.68 8.68 0 00-4.088-3.957A8.68 8.68 0 0012 3a8.68 8.68 0 00-4.53 1.273A8.68 8.68 0 003.382 7.73 8.68 8.68 0 003 12a8.68 8.68 0 001.273 4.53 8.68 8.68 0 003.957 4.088A8.68 8.68 0 0012 21a8.68 8.68 0 004.53-1.273 8.68 8.68 0 004.088-3.957A8.68 8.68 0 0021 12a8.68 8.68 0 00-1.273-4.53z"/>
                    </svg>
                    Claim Filing Guide: Get Reimbursed
                </h2>
                <p class="text-xl text-slate-600">
                    You are about to file
                    <span id="filing-claim-count" class="font-bold text-[var(--rh-primary)]"></span>
                    claims worth
                    <span id="filing-claim-value" class="font-bold text-[var(--rh-success)]"></span>.
                </p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 1: Copy Claim Data (JSON)
                    </h3>
                    <p class="text-sm text-slate-600 mb-2">
                        Use this structured data to communicate the exact issue, SKU, and transaction ID to Amazon Support.
                    </p>

                    <div class="bg-gray-800 text-green-400 p-4 rounded-lg relative">
                        <pre id="claim-json-data" class="text-xs"></pre>
                        <button
                            onclick="copyClaimData()"
                            class="absolute top-2 right-2 p-2 bg-gray-700 rounded-lg text-white hover:bg-gray-600 transition text-xs font-medium"
                        >
                            <span id="copy-btn-text">Copy JSON</span>
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 2: File on Seller Central
                    </h3>
                    <ol class="list-decimal list-inside space-y-3 text-sm text-slate-700">
                        <li>
                            Go to <strong>Seller Central Help</strong> →
                            <a
                                href="https://sellercentral.amazon.com/gp/contact-us/performance/ref=ag_contactus_foot_perfd_cont_201642190"
                                target="_blank"
                                class="text-blue-600 hover:underline font-medium"
                            >
                                Contact Us
                            </a>
                        </li>
                        <li>Select “Selling on Amazon Issue” → “FBA Issue” → <strong>Investigate Missing / Damaged Units</strong>.</li>
                        <li>Paste the JSON directly into the case description.</li>
                        <li>Attach the original CSV as evidence.</li>
                        <li>Submit the case and track reimbursements.</li>
                    </ol>
                </div>
            </div>

            <div class="mt-10">
                <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                    Step 3: Copy/Paste Ready-Made Amazon Case Messages
                </h3>

                <p class="text-sm text-slate-600 mb-4">
                    These are ready-to-send message templates for each claim. Paste into Seller Central.
                </p>

                <div
                    id="claim-messages"
                    class="space-y-4 max-h-64 overflow-y-auto text-left bg-gray-50 p-4 rounded-xl border border-gray-200"
                ></div>
            </div>

            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="rh-primary-btn mt-10 w-full py-3 text-white rounded-xl font-bold shadow-lg transition"
            >
                I Understand – Close Guide
            </button>
        </div>
    </div>

<!-- AUTH MODALS -->
<div id="auth-overlay"
     class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4"
     onclick="closeModalOnOutsideClick(event)">
    
    <div id="login-modal"
         class="hidden bg-white p-8 rounded-2xl max-w-md w-full shadow-xl relative"
         onclick="event.stopPropagation()">

        <button
            onclick="closeAuthModals()"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            ✕
        </button>

        <h2 class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">Log In</h2>
        <p class="text-sm text-gray-600 mb-6">Access your FBA Money Scout dashboard</p>

        <input id="login-email"
               type="email"
               placeholder="Email"
               class="w-full mb-3 p-3 rounded-lg border border-gray-300 rh-focus">

        <input id="login-password"
               type="password"
               placeholder="Password"
               class="w-full mb-4 p-3 rounded-lg border border-gray-300 rh-focus">

        <button onclick="loginUser()"
                class="rh-primary-btn w-full py-3 text-white rounded-xl font-bold">
            Log In
        </button>

        <p class="text-sm mt-4 text-center text-gray-500">
            Need an account?
            <span onclick="switchToSignup()"
                class="text-[var(--rh-primary)] font-semibold cursor-pointer">
                Create one
            </span>
        </p>
    </div>

    <div id="signup-modal"
         class="hidden bg-white p-8 rounded-2xl max-w-md w-full shadow-xl relative"
         onclick="event.stopPropagation()">

        <button
            onclick="closeAuthModals()"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            ✕
        </button>

        <h2 class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">Create Account</h2>
        <p class="text-sm text-gray-600 mb-6">Start tracking your reimbursements</p>

        <input id="signup-email"
               type="email"
               placeholder="Email"
               class="w-full mb-3 p-3 rounded-lg border border-gray-300 rh-focus">

        <input id="signup-password"
               type="password"
               placeholder="Password"
               class="w-full mb-4 p-3 rounded-lg border border-gray-300 rh-focus">

        <button onclick="signupUser()"
                class="rh-primary-btn w-full py-3 text-white rounded-xl font-bold">
            Create Account
        </button>

        <p class="text-sm mt-4 text-center text-gray-500">
            Already have an account?
            <span onclick="switchToLogin()"
                class="text-[var(--rh-primary)] font-semibold cursor-pointer">
                Log in
            </span>
        </p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        signInWithCustomToken,
        signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        collection,
        query,
        orderBy,
        serverTimestamp,
        runTransaction,
        limit
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // =================================================================
    // --- FIREBASE CONFIGURATION AND INITIALIZATION (MANDATORY) ---
    // =================================================================
    
    // Global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (Object.keys(firebaseConfig).length === 0) {
        console.error("Firebase configuration is missing. Cannot initialize Firebase.");
        // Fallback for environment testing outside of Canvas
        firebaseConfig.projectId = 'mock-project-id';
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    // =================================================================

    const AUDIT_LIMIT = 5;
    let userId = null;
    let auditsUsed = 0;
    let isPremium = false;
    let uploadedFileContent = null;
    let selectedFileName = "";
    let currentClaimsData = [];
    let currentTotalValue = 0;
    let currentClaimMessages = [];
    let chartInstance = null;
    
    // =================================================================
    // --- AUTH & USER PROFILE LOGIC ---
    // =================================================================

    function updateNavUI(user) {
        if (user) {
            document.getElementById('nav-login-btn').classList.add('hidden');
            document.getElementById('nav-logout-btn').classList.remove('hidden');
            document.getElementById('status-message').textContent = `Welcome back, ${user.email || 'User'}. Ready to audit!`;
        } else {
            document.getElementById('nav-login-btn').classList.remove('hidden');
            document.getElementById('nav-logout-btn').classList.add('hidden');
            document.getElementById('status-message').textContent = `You must be logged in to audit a report.`;
            document.getElementById('audit-button').disabled = true;
            // Clear file selection when logging out
            document.getElementById('csv-file').value = null;
            document.getElementById('file-name-display').textContent = 'Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)';
            document.getElementById('history-list').innerHTML = '<p id="history-loading" class="text-slate-500 italic">You must be logged in to view history.</p>';
            renderUsage(0, false); // Reset usage display
            hideResults();
        }
    }

    // Listens for authentication state changes (login/logout)
    onAuthStateChanged(auth, (user) => {
        userId = user ? user.uid : null;
        updateNavUI(user);
        if (user) {
            subscribeToUserData(user.uid);
            // Audit history is saved in public collection for simplicity but tagged with userId
            subscribeToAuditHistory(user.uid); 
        }
    });

    async function initialSignIn() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Initial sign-in failed:", error);
            // Fallback to anonymous if token fails
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Anonymous sign-in failed:", e);
            }
        }
    }

    function subscribeToUserData(uid) {
        // Private data path: /artifacts/{appId}/users/{userId}/data
        const userDocRef = doc(db, 'artifacts', appId, 'users', uid, 'data', 'profile');
        onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                auditsUsed = data.auditsUsed || 0;
                // isPremium = data.plan === 'pro_hunter_monthly'; // Assuming this check
                isPremium = auditsUsed > AUDIT_LIMIT; // Mock check for demo purposes
                renderUsage(auditsUsed, isPremium);
            } else {
                // Initialize new user data if it doesn't exist
                setDoc(userDocRef, { auditsUsed: 0, plan: 'trial', created: serverTimestamp() }, { merge: true });
                renderUsage(0, false);
            }
        });
    }

    function subscribeToAuditHistory(uid) {
        // Public data path: /artifacts/{appId}/public/data/audits
        const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'audits');
        // Query to only show the user's audits, ordered by date
        const q = query(historyRef, orderBy("timestamp", "desc"), limit(5));

        onSnapshot(q, (snapshot) => {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (snapshot.empty) {
                historyList.innerHTML = '<p class="text-slate-500 italic">No previous audits found.</p>';
                return;
            }

            snapshot.docs.forEach(doc => {
                const data = doc.data();
                // Only show history for the current logged-in user
                if (data.userId !== uid) return; 

                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'N/A';
                const item = `
                    <div class="p-4 bg-white rounded-lg border border-gray-200 shadow-sm flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-slate-800">${data.fileName || 'Audit Report'}</p>
                            <p class="text-sm text-gray-500">Processed on: ${date}</p>
                        </div>
                        <span class="font-bold text-lg text-[var(--rh-success)]">
                            ${data.claimCount || 0} claims ($${(data.totalValue || 0).toFixed(2)})
                        </span>
                    </div>
                `;
                historyList.insertAdjacentHTML('beforeend', item);
            });
            if (historyList.children.length === 0) {
                 historyList.innerHTML = '<p class="text-slate-500 italic">No previous audits found for this user.</p>';
            }
        });
    }

    window.loginUser = async function() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
            closeAuthModals();
        } catch (error) {
            console.error("Login failed:", error);
            // Using a simple custom message box in place of alert()
            showTemporaryMessage("Login Failed", `Error: ${error.message}`, 'error');
        }
    }

    window.signupUser = async function() {
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        if (password.length < 6) {
            showTemporaryMessage("Signup Failed", "Password must be at least 6 characters long.", 'error');
            return;
        }
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            // Initialize Firestore user profile document in the private path
            const userDocRef = doc(db, 'artifacts', appId, 'users', userCredential.user.uid, 'data', 'profile');
            await setDoc(userDocRef, {
                email: email,
                auditsUsed: 0,
                plan: 'trial',
                created: serverTimestamp()
            });
            closeAuthModals();
        } catch (error) {
            console.error("Signup failed:", error);
            showTemporaryMessage("Signup Failed", `Error: ${error.message}`, 'error');
        }
    }

    window.logoutUser = async function() {
        await signOut(auth);
        showTemporaryMessage("Logged Out", "You have been successfully logged out.", 'success');
    }
    
   // =================================================================
// --- SAFE FILE HANDLING WITH LOGIN + REAL-WORLD CSV PROTECTION ---
// =================================================================

window.requireLoginThenSelectFile = function(event) {
    const file = event.target.files[0];
    const fileNameDisplay = document.getElementById('file-name-display');
    const auditButton = document.getElementById('audit-button');

    // Reset UI each time
    uploadedFileContent = null;
    selectedFileName = "";
    auditButton.disabled = true;

    // ------------------------------------------
    // 1) Require FULL login (no anonymous users)
    // ------------------------------------------
    if (!auth.currentUser || auth.currentUser.isAnonymous) {
        showTemporaryMessage(
            "Login Required",
            "Please log in or create an account before uploading FBA reports.",
            "warning"
        );
        event.target.value = null; // Clear the file picker
        openLoginModal();
        return;
    }

    // -------------------------
    // 2) Must select a file
    // -------------------------
    if (!file) {
        fileNameDisplay.textContent = "Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)";
        return;
    }

    // --------------------------------------------
    // 3) File type must be .csv (Amazon exports)
    // --------------------------------------------
    if (file.type !== "text/csv" && !file.name.toLowerCase().endsWith(".csv")) {
        fileNameDisplay.textContent = "Error: Please upload a .csv file only.";
        fileNameDisplay.classList.add("text-red-500");
        event.target.value = null;
        return;
    }

    // ---------------------------------------------------
    // 4) Safety: Amazon CSVs can get HUGE. Limit to ~10MB
    // ---------------------------------------------------
    const MAX_BYTES = 10 * 1024 * 1024; // 10 MB
    if (file.size > MAX_BYTES) {
        fileNameDisplay.textContent =
            "Your file is too large. Please export a smaller date range (max ~10 MB).";
        fileNameDisplay.classList.add("text-red-500");
        event.target.value = null;
        return;
    }

    // ----------------------------------------------------
    // 5) Read the file into memory
    // ----------------------------------------------------
    selectedFileName = file.name;
    fileNameDisplay.textContent = `File Selected: ${selectedFileName}`;
    fileNameDisplay.classList.remove("text-red-500");

    const reader = new FileReader();

    reader.onload = (e) => {
        const text = e.target.result || "";

        // ----------------------------------------------------
        // 6) Empty CSV guard (VERY common issue with Seller Central)
        // ----------------------------------------------------
        if (!text.trim()) {
            fileNameDisplay.textContent = "This CSV appears empty. Please re-download from Seller Central.";
            fileNameDisplay.classList.add("text-red-500");
            event.target.value = null;
            return;
        }

        uploadedFileContent = text;
        auditButton.disabled = false;
        auditButton.textContent = `Audit Report (${selectedFileName})`;
    };

    reader.onerror = () => {
        fileNameDisplay.textContent = "Error reading file.";
        fileNameDisplay.classList.add("text-red-500");
        event.target.value = null;
        uploadedFileContent = null;
    };

    reader.readAsText(file);
};


    window.runAudit = async function() {
        if (!uploadedFileContent || !userId) {
            showTemporaryMessage("Error", "Please select a file and ensure you are logged in.", 'error');
            return;
        }

        // Check audit limits
        if (auditsUsed >= AUDIT_LIMIT && !isPremium) {
            showTemporaryMessage("Upgrade Needed", `You have used your ${AUDIT_LIMIT} free audits. Please upgrade to continue.`, 'warning');
            showUpgradeModal('audit_monthly');
            return;
        }

        document.getElementById('upload-section').classList.add('hidden');
        document.getElementById('loading-indicator').classList.remove('hidden');
        hideResults();
        
        // --- MOCK API CALL SIMULATION ---
        await new Promise(resolve => setTimeout(resolve, 3000)); // Simulate network latency

        try {
            // In a real application, you would send uploadedFileContent (CSV string) to a backend API 
            // for processing by a powerful model (like Gemini) or a dedicated service.
            
            const results = generateMockAuditData(selectedFileName); // Mock data generation
            
            currentClaimsData = results.claims;
            currentTotalValue = results.totalValue;
            currentClaimMessages = results.claimMessages;

            await incrementAuditCount(); // Update usage count in Firebase
            saveAuditHistory(results); // Save audit details

            renderResults(results);

        } catch (error) {
            console.error("Audit failed:", error);
            showTemporaryMessage("Audit Failed", `An error occurred during analysis: ${error.message}`, 'error');
        } finally {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            // Re-disable button until new file is selected
            document.getElementById('audit-button').disabled = true; 
        }
    }

    async function incrementAuditCount() {
        if (!userId) return;
        
        // Private data path: /artifacts/{appId}/users/{userId}/data
        const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'profile');

        try {
            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(userDocRef);
                if (!userDoc.exists()) {
                    // Create if missing (should be created on signup/first login)
                    transaction.set(userDocRef, { auditsUsed: 1, plan: 'trial', created: serverTimestamp() });
                } else {
                    const newAuditsUsed = (userDoc.data().auditsUsed || 0) + 1;
                    transaction.update(userDocRef, { auditsUsed: newAuditsUsed });
                }
            });
        } catch (e) {
            console.error("Audit usage transaction failed: ", e);
        }
    }

    function saveAuditHistory(results) {
        if (!userId) return;
        // Public data path: /artifacts/{appId}/public/data/audits
        const auditRef = collection(db, 'artifacts', appId, 'public', 'data', 'audits');
        setDoc(doc(auditRef), {
            userId: userId,
            fileName: selectedFileName,
            claimCount: results.claims.length,
            totalValue: results.totalValue,
            timestamp: serverTimestamp(),
            // Only store metadata to keep document size small
        });
    }

    // =================================================================
    // --- UI RENDERING & UTILITIES ---
    // =================================================================
    
    // Simple temporary message box (replaces alert/confirm)
    function showTemporaryMessage(title, message, type) {
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-red-500';
        const modalId = `temp-modal-${Date.now()}`;
        const modalHtml = `
            <div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onclick="document.getElementById('${modalId}').remove()">
                <div class="${bgColor} text-white p-6 rounded-xl shadow-2xl max-w-sm w-full animate-bounce-in" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-sm">${message}</p>
                    <button class="mt-4 text-xs font-semibold underline opacity-80" onclick="document.getElementById('${modalId}').remove()">Dismiss</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        setTimeout(() => {
            const el = document.getElementById(modalId);
            if (el) el.remove();
        }, 5000); // Auto-dismiss after 5 seconds
    }

    function renderUsage(used, premium) {
        const remaining = AUDIT_LIMIT - used;
        const percentage = Math.min((used / AUDIT_LIMIT) * 100, 100);

        document.getElementById('audits-used').textContent = used;
        document.getElementById('audits-remaining').textContent = Math.max(0, remaining);
        document.getElementById('usage-bar').style.width = `${percentage}%`;
        document.getElementById('subscription-status').textContent = premium ? 'Pro Hunter (Unlimited)' : 'Trial User';
        
        if (remaining <= 0 && !premium) {
            document.getElementById('usage-display').classList.remove('text-blue-600');
            document.getElementById('usage-display').classList.add('text-red-600');
        } else {
             document.getElementById('usage-display').classList.remove('text-red-600');
             document.getElementById('usage-display').classList.add('text-blue-600');
        }
    }
    
    function hideResults() {
        document.getElementById('results-area').classList.add('hidden');
        document.getElementById('no-claims-found').classList.add('hidden');
    }

    function renderResults(results) {
        const { claims, totalValue } = results;
        
        document.getElementById('results-area').classList.remove('hidden');
        document.getElementById('claim-count').textContent = claims.length;
        document.getElementById('total-value-display').textContent = `$${totalValue.toFixed(2)}`;

        const claimList = document.getElementById('claim-list');
        claimList.innerHTML = '';

        if (claims.length === 0) {
            document.getElementById('no-claims-found').classList.remove('hidden');
            document.getElementById('file-claims-btn').disabled = true;
            renderChart([]);
            return;
        }

        document.getElementById('file-claims-btn').disabled = false;
        document.getElementById('no-claims-found').classList.add('hidden');

        // Render individual claim items
        claims.forEach(claim => {
            const claimItem = `
                <div class="p-4 bg-white rounded-lg border border-red-200 shadow-sm transition hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-lg text-[var(--rh-dark)]">${claim.reason} Claim</h4>
                        <span class="text-xl font-extrabold text-red-600">$${claim.potentialValue.toFixed(2)}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">
                        <span class="font-semibold">SKU:</span> ${claim.sku} | 
                        <span class="font-semibold">Quantity:</span> ${claim.quantity} | 
                        <span class="font-semibold">Transaction:</span> ${claim.transactionId}
                    </p>
                    <p class="text-xs text-gray-500 mt-2">${claim.description}</p>
                </div>
            `;
            claimList.insertAdjacentHTML('beforeend', claimItem);
        });
        
        renderChart(claims);
    }
    
    function renderChart(claims) {
        const ctx = document.getElementById('claim-chart').getContext('2d');
        
        // Destroy old chart instance if it exists
        if (chartInstance) {
            chartInstance.destroy();
        }

        const reasonMap = claims.reduce((acc, claim) => {
            acc[claim.reason] = (acc[claim.reason] || 0) + claim.potentialValue;
            return acc;
        }, {});
        
        const labels = Object.keys(reasonMap);
        const data = Object.values(reasonMap);
        
        chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#FE9900', // rh-primary
                        '#3b82f6', // blue-500
                        '#4BB543', // rh-success
                        '#ef4444', // red-500
                        '#10b981', // emerald-500
                        '#eab308'  // yellow-500
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // =================================================================
    // --- MODAL AND AUTH UTILITY FUNCTIONS ---
    // =================================================================

    window.openLoginModal = function() {
        document.getElementById('auth-overlay').classList.remove('hidden');
        document.getElementById('login-modal').classList.remove('hidden');
        document.getElementById('signup-modal').classList.add('hidden');
    }

    window.switchToSignup = function() {
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('signup-modal').classList.remove('hidden');
    }

    window.switchToLogin = function() {
        document.getElementById('signup-modal').classList.add('hidden');
        document.getElementById('login-modal').classList.remove('hidden');
    }

    window.closeAuthModals = function() {
        document.getElementById('auth-overlay').classList.add('hidden');
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('signup-modal').classList.add('hidden');
    }

    window.closeModalOnOutsideClick = function(event) {
        if (event.target.id === 'auth-overlay') {
            closeAuthModals();
        }
        if (event.target.id === 'upgrade-modal') {
            document.getElementById('upgrade-modal').classList.add('hidden');
        }
        if (event.target.id === 'claim-filing-modal') {
            document.getElementById('claim-filing-modal').classList.add('hidden');
        }
    }

    window.showUpgradeModal = function(planId) {
        const modal = document.getElementById('upgrade-modal');
        const title = document.getElementById('modal-title');
        const price = document.getElementById('modal-price');
        const desc = document.getElementById('modal-description');
        const link = document.getElementById('modal-checkout-link');
        
        // Mock checkout links (replace with Stripe/PayPal links)
        const plans = {
            'audit_single': { title: 'Single Audit Boost', price: '$99 USD', desc: 'One-time audit for large reports. No monthly commitment.', link: '#single-checkout' },
            'audit_monthly': { title: 'Pro Hunter Monthly', price: '$199 / Month', desc: 'Unlimited monthly audits, priority support, and all features.', link: '#monthly-checkout' }
        };

        const plan = plans[planId];

        title.textContent = plan.title;
        price.textContent = plan.price;
        desc.textContent = plan.desc;
        link.href = plan.link;

        modal.classList.remove('hidden');
    }
    
    window.openClaimFilingModal = function() {
        if (currentClaimsData.length === 0) {
            showTemporaryMessage("No Claims", "No claims were found in the last audit to file.", 'warning');
            return;
        }

        const countDisplay = document.getElementById('filing-claim-count');
        const valueDisplay = document.getElementById('filing-claim-value');
        const jsonDisplay = document.getElementById('claim-json-data');
        const messageDisplay = document.getElementById('claim-messages');

        countDisplay.textContent = currentClaimsData.length;
        valueDisplay.textContent = `$${currentTotalValue.toFixed(2)}`;

        // Display combined JSON data for all claims
        jsonDisplay.textContent = JSON.stringify(currentClaimsData, null, 2);

        // Display individual claim messages
        messageDisplay.innerHTML = currentClaimMessages.map((msg, index) => {
            // Escape backticks and newlines for use in the onclick string
            const escapedMsg = msg.replace(/`/g, '\\`').replace(/\n/g, '\\n');
            return `
                <div class="bg-white p-3 rounded-lg border border-gray-300">
                    <p class="font-semibold text-sm text-[var(--rh-dark)]">Claim ${index + 1}: ${currentClaimsData[index].reason}</p>
                    <pre class="text-xs mt-1 whitespace-pre-wrap">${msg}</pre>
                    <button 
                        onclick="copySingleMessage(this, \`${escapedMsg}\`)" 
                        class="mt-2 text-xs text-blue-600 hover:underline">
                        Copy This Message
                    </button>
                </div>
            `;
        }).join('');

        document.getElementById('claim-filing-modal').classList.remove('hidden');
    }

    window.copyClaimData = function() {
        const jsonText = document.getElementById('claim-json-data').textContent;
        // Check if navigator.clipboard is available (modern way)
        if (navigator.clipboard) {
            navigator.clipboard.writeText(jsonText).then(() => {
                flashCopyText(document.getElementById('copy-btn-text'), 'Copied!');
            }).catch(err => {
                console.error('Failed to copy text (Clipboard API failed): ', err);
                // Fallback to execCommand (deprecated but often works in iframe environments)
                fallbackCopyTextToClipboard(jsonText);
            });
        } else {
            fallbackCopyTextToClipboard(jsonText);
        }
    }
    
    // Fallback for copy command in restricted environments
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";  // Avoid scrolling to bottom of page
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            flashCopyText(document.getElementById('copy-btn-text'), 'Copied!');
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            showTemporaryMessage('Copy Failed', 'Please manually copy the text from the box.', 'error');
        }
        document.body.removeChild(textArea);
    }

    function flashCopyText(element, text) {
        const originalText = element.textContent;
        element.textContent = text;
        setTimeout(() => { element.textContent = originalText; }, 1500);
    }
    
    window.copySingleMessage = function(button, message) {
        navigator.clipboard.writeText(message).then(() => {
            flashCopyText(button, 'Copied!');
        }).catch(err => {
             console.error('Failed to copy single message: ', err);
             // Fallback logic for single message copy is simplified
             showTemporaryMessage('Copy Failed', 'Please manually select and copy the message text.', 'error');
        });
    }
    
    // =================================================================
    // --- MOCK DATA GENERATION (To be replaced by real AI API call) ---
    // =================================================================
    
    function generateMockAuditData(fileName) {
        const reasons = [
            "Warehouse Damaged",
            "Lost in Transit to Customer",
            "Missing in Action (MIA) after 30 days",
            "Incorrectly Charged Fee",
            "Customer Return Loss"
        ];
        const skus = ["SKU-A101", "SKU-B202", "SKU-C303", "SKU-D404", "SKU-E505"];
        const numClaims = Math.floor(Math.random() * 8) + 3; // 3 to 10 claims
        let totalValue = 0;
        const claims = [];
        const claimMessages = [];

        for (let i = 0; i < numClaims; i++) {
            const reason = reasons[Math.floor(Math.random() * reasons.length)];
            const sku = skus[Math.floor(Math.random() * skus.length)];
            const quantity = Math.floor(Math.random() * 3) + 1;
            const potentialValue = (Math.random() * 40 + 10) * quantity;
            totalValue += potentialValue;
            
            const transactionId = `T${Math.floor(Math.random() * 90000000) + 10000000}`;

            const claim = {
                id: i + 1,
                reason: reason,
                sku: sku,
                quantity: quantity,
                potentialValue: parseFloat(potentialValue.toFixed(2)),
                transactionId: transactionId,
                dateFound: new Date().toISOString().split('T')[0],
                report: fileName,
                description: `Discrepancy found in FBA inventory ledger for SKU ${sku}. ${reason} for ${quantity} unit(s) linked to transaction ID ${transactionId}. Reimbursement is due.`
            };
            
            claims.push(claim);
            
            // Generate a copy/paste message for Amazon
            const message = `
Hello Amazon Seller Support,

I am requesting an investigation and reimbursement for a discrepancy found in my inventory report (${fileName}).

Issue: ${reason}
SKU: ${sku}
Quantity Due: ${quantity} units
Relevant Transaction ID: ${transactionId}

Please review the attached Inventory Ledger Report, which confirms the missing or damaged units.

Thank you.
            `.trim();
            claimMessages.push(message);
        }

        return {
            claims: claims,
            totalValue: parseFloat(totalValue.toFixed(2)),
            claimMessages: claimMessages
        };
    }
    
    // Initialize the UI and Firebase on page load
    window.onload = () => {
        initialSignIn();
    };
</script>
</body>
</html>

