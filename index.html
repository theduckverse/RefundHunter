<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FBA Money Scout - FBA Reimbursement Audit Tool</title>
    
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rh-primary': '#FE9900',
                        'rh-dark': '#232f3e',
                        'rh-success': '#4BB543',
                        'rh-bg-light': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                },
            },
        }
    </script>

    <style>
        :root {
            --rh-primary: #FE9900;
            --rh-success: #4BB543;
            --rh-dark: #232f3e;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .rh-primary-btn {
            background-color: var(--rh-primary);
            box-shadow: 0 4px 6px -1px rgba(254, 153, 0, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .rh-primary-btn:hover:not(:disabled) {
            background-color: #e68a00;
            transform: translateY(-1px);
        }

        .rh-secondary-btn {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .rh-secondary-btn:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        .rh-focus:focus {
            border-color: var(--rh-primary);
            box-shadow: 0 0 0 3px rgba(254, 153, 0, 0.3);
            outline: none;
        }

        .main-card-shadow {
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 0 10px rgba(0, 0, 0, 0.02);
        }

        #claim-chart {
            width: 100%;
            height: 250px;
        }

        #claim-json-data {
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="text-slate-800">

<!-- ======= NAVBAR ======= -->
<nav class="backdrop-blur-lg bg-white/70 border-b border-gray-200/60 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex flex-col leading-tight">
            <span class="text-2xl font-extrabold text-[var(--rh-dark)] tracking-tight">
                FBA Money Scout
                <span class="ml-2 h-2 w-2 bg-[var(--rh-primary)] rounded-full inline-block opacity-80"></span>
            </span>
            <span class="text-xs text-gray-500">Stop losing money to Amazon‚Äôs errors</span>
        </div>

        <div class="hidden md:flex items-center space-x-10 font-medium">
            <a href="#upload-section" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Dashboard
            </a>
            <a href="#history-area" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                History
            </a>
            <a href="#pricing" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Pricing
            </a>
            <a href="#profile-area" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Account
            </a>
        </div>

        <div class="flex items-center space-x-4">
            <button id="nav-login-btn"
                    class="text-[var(--rh-primary)] font-semibold hover:underline"
                    onclick="openLoginModal()">
                Log In
            </button>
            <button id="nav-logout-btn"
                    class="hidden text-gray-600 font-semibold hover:underline"
                    onclick="logoutUser()">
                Log Out
            </button>
            <button
                onclick="document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' })"
                class="bg-gradient-to-r from-orange-400 to-orange-600 text-white px-4 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                Upgrade
            </button>
        </div>
    </div>
</nav>
<!-- HERO SECTION -->
<section class="w-full bg-white py-16 px-4 md:px-10 border-b border-gray-100">
  <div class="max-w-6xl mx-auto text-center">
    <h1 class="text-4xl md:text-6xl font-extrabold text-[var(--rh-dark)] leading-tight">
      <span class="text-[var(--rh-primary)]">FBA Money Scout</span>
      <span class="text-[var(--rh-dark)]"> | FBA Reimbursement Audit</span>
    </h1>
    <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">
      Stop losing money to Amazon‚Äôs errors. Upload your Inventory Report and instantly generate
      a list of exact, actionable reimbursement claims.
    </p>
  </div>
</section>

<!-- MAIN APPLICATION CONTAINER -->
<div class="min-h-screen flex flex-col items-center p-4">
    <!-- FILE UPLOAD AND ACTION AREA -->
    <main class="w-full max-w-2xl bg-white p-8 rounded-xl mt-10 main-card-shadow border border-gray-200">
        <div id="upload-section">
            <h2 class="text-2xl font-semibold mb-6 text-slate-800">
                1. Upload Your Amazon Report (.CSV)
            </h2>
            <p id="status-message" class="text-sm text-gray-500 mb-4"></p>

            <div class="mt-4 mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
                <h3 class="font-bold text-blue-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    Where to find your report:
                </h3>
                <ul class="list-disc list-inside text-sm text-blue-700 mt-2 space-y-1">
                    <li>Go to <strong>Amazon Seller Central</strong> ‚Üí Reports ‚Üí Fulfillment.</li>
                    <li>Download the <strong>Inventory Ledger Report</strong> or <strong>Daily Inventory History Report</strong>.</li>
                    <li>Ensure the file format is <strong>.CSV</strong> and includes the full transaction history.</li>
                </ul>
            </div>

            <!-- DRAG & DROP FILE AREA -->
            <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-xl text-center hover:border-[var(--rh-primary)] transition duration-200">
                <label for="csv-file" class="cursor-pointer block py-4">
                    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4h-1"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 15l-3-3m0 0l-3 3m3-3v8"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600 font-medium" id="file-name-display">
                        Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)
                    </p>
                </label>
                <input 
                    type="file"
                    id="csv-file"
                    accept=".csv"
                    class="hidden"
                    onchange="requireLoginThenSelectFile(event)"
                />
            </div>

            <div class="flex items-center justify-between">
                <button
                    id="audit-button"
                    class="rh-primary-btn px-8 py-3 text-white rounded-xl font-bold shadow-lg transition disabled:opacity-50"
                    disabled
                >
                    Audit Report (Loading...)
                </button>
                <a href="#pricing" class="text-sm text-[var(--rh-primary)] hover:underline font-medium">
                    See Pricing Plans
                </a>
            </div>

            <p class="text-xs text-gray-500 mt-4">
                Note: No raw data is stored. Your file content is sent directly to the AI for analysis.
            </p>
        </div>
        
        <div id="loading-indicator" class="hidden text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-[var(--rh-primary)] border-t-transparent mx-auto mb-4"></div>
            <p class="text-slate-700 font-medium">
                Analyzing over 10,000 lines of data... this may take a moment.
            </p>
        </div>
    </main>
    
    <!-- RESULTS DISPLAY AREA -->
    <section
        id="results-area"
        class="hidden w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-3xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">0</span>
            Actionable Reimbursement Claims Found
        </h2>
        
        <div id="chart-container" class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
            <h3 class="text-xl font-semibold text-slate-800 mb-4">
                Claim Value Breakdown by Reason
            </h3>
            <canvas id="claim-chart"></canvas>
        </div>
        
        <div id="claim-list" class="space-y-4"></div>

        <div
            id="no-claims-found"
            class="hidden bg-green-50 p-4 rounded-lg border border-green-200 mt-4"
        >
            <p class="text-green-700 font-medium">
                Great news! Our audit found no immediate discrepancies requiring a claim in this report.
            </p>
        </div>
    </section>

    <!-- PROFILE / USAGE SECTION -->
    <section
        id="profile-area"
        class="w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Your Profile & Usage
        </h2>

        <div class="grid md:grid-cols-2 gap-6 mt-4">
            <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                <h3 class="font-semibold text-lg text-blue-800 mb-2">Audit Limits</h3>
                <p class="text-4xl font-extrabold text-blue-600 mb-3" id="usage-display">
                    <span id="audits-used">0</span> / 5
                    <span class="text-base font-normal text-blue-500">Free Audits Used</span>
                </p>
                <div id="usage-progress" class="w-full bg-blue-200 rounded-full h-2.5">
                    <div id="usage-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-sm text-blue-700 mt-2">
                    <span id="audits-remaining">5</span> audits remaining before upgrade is suggested.
                </p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-gray-300 shadow">
                <h3 class="font-semibold text-lg text-slate-800 mb-2">Subscription Status</h3>
                <p class="text-xl font-bold text-gray-700" id="subscription-status">Trial User</p>
                <p class="text-sm text-slate-500 mt-1 mb-4">
                    Current plan includes <strong>5 free audits</strong> for testing.
                </p>
                <button
                    onclick="showUpgradeModal('audit_monthly')"
                    class="rh-primary-btn px-4 py-2 text-sm text-white rounded-lg font-medium"
                >
                    Manage Subscription / Upgrade
                </button>
            </div>
        </div>
    </section>

    <!-- HISTORY DISPLAY AREA -->
    <section id="history-area" class="w-full max-w-4xl mt-10 p-6">
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4">Audit History</h2>
        <div id="history-list" class="space-y-4">
            <p id="history-loading" class="text-slate-500 italic">
                Loading previous audits...
            </p>
        </div>
    </section>

    <!-- PRICING SECTION -->
    <section id="pricing" class="py-16 bg-white mt-10 w-full border-t border-gray-200">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold mb-3 text-slate-900">
                Stop Leaving Money on the Table
            </h2>
            <p id="free-uses-display" class="text-xl text-slate-600 mb-12">
                Your first 5 audits are free.
            </p>

            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <div class="bg-gray-50 p-6 rounded-2xl border-2 border-gray-300 flex flex-col justify-between">
                    <div>
                        <p class="text-lg font-bold text-gray-700 mb-4">Trial Audit</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">FREE</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            Limited to the first 5 reports
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                5 Full-Report Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>
                    <button
                        class="mt-8 w-full py-3 rounded-xl bg-gray-200 text-gray-500 font-bold cursor-default opacity-80"
                        disabled
                    >
                        Currently Active
                    </button>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-xl border-2 border-gray-300 flex flex-col justify-between hover:border-blue-400 transition">
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">Single Audit Boost</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$99</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            One-time purchase per report
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                1 Full-Report Audit
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>
                    <button
                        onclick="showUpgradeModal('audit_single')"
                        class="mt-8 w-full py-3 rounded-xl rh-secondary-btn font-bold"
                    >
                        Purchase Single Audit
                    </button>
                </div>

                <div class="relative bg-white p-6 rounded-2xl shadow-2xl border-4 border-[var(--rh-primary)] scale-[1.05] flex flex-col justify-between">
                    <div class="absolute top-0 right-0 -mt-3 -mr-3 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full uppercase shadow-md">
                        Best Value
                    </div>
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">Pro Hunter Monthly</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$199</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            Billed Monthly for serious sellers
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                <strong>Unlimited</strong> Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                Priority Support
                            </li>
                        </ul>
                    </div>
                    <button
                        onclick="showUpgradeModal('audit_monthly')"
                        class="mt-8 rh-primary-btn w-full text-white p-3 rounded-xl font-bold transition"
                    >
                        Go Pro: Start Unlimited
                    </button>
                </div>
            </div>
        </div>
    </section>
    
    <footer class="py-8 bg-[var(--rh-dark)] text-center w-full text-slate-400 mt-10">
        <p>¬© 2025 FBA Money Scout. Designed for FBA Sellers.</p>
    </footer>

    <!-- UPGRADE MODAL -->
    <div
        id="upgrade-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-md w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center">
                <svg
                    id="modal-icon"
                    class="h-12 w-12 text-[var(--rh-primary)] mx-auto mb-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V4m0 16v-4m-6-3H4m16 0h-4"/>
                </svg>
                <h2 id="modal-title" class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">
                    Upgrade Plan
                </h2>
                <p id="modal-price" class="text-4xl font-extrabold text-[var(--rh-success)] mb-4"></p>
                <p id="modal-description" class="text-slate-600 mb-6"></p>
            </div>
            
            <div class="space-y-3">
                <a
                    id="modal-checkout-link"
                    target="_blank"
                    class="rh-primary-btn w-full inline-block text-white p-3 rounded-xl font-semibold text-center transition"
                >
                    Secure Checkout & Unlock Audits
                </a>
                <button
                    onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                    class="w-full p-3 rounded-xl border border-slate-300 bg-gray-50 hover:bg-gray-100 transition font-medium"
                >
                    Cancel and Go Back
                </button>
            </div>
        </div>
    </div>

    <!-- CLAIM FILING MODAL -->
    <div
        id="claim-filing-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-start z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-3xl w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-2 text-[var(--rh-dark)] flex items-center justify-center">
                    <svg
                        class="h-8 w-8 text-[var(--rh-success)] mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9 12l2 2 4-4m5.618-4.27a8.68 8.68 0 00-4.088-3.957A8.68 8.68 0 0012 3a8.68 8.68 0 00-4.53 1.273A8.68 8.68 0 003.382 7.73 8.68 8.68 0 003 12a8.68 8.68 0 001.273 4.53 8.68 8.68 0 003.957 4.088A8.68 8.68 0 0012 21a8.68 8.68 0 004.53-1.273 8.68 8.68 0 004.088-3.957A8.68 8.68 0 0021 12a8.68 8.68 0 00-1.273-4.53z"/>
                    </svg>
                    Claim Filing Guide: Get Reimbursed
                </h2>
                <p class="text-xl text-slate-600">
                    You are about to file
                    <span id="filing-claim-count" class="font-bold text-[var(--rh-primary)]"></span>
                    claims worth
                    <span id="filing-claim-value" class="font-bold text-[var(--rh-success)]"></span>.
                </p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 1: Copy Claim Data (JSON)
                    </h3>
                    <p class="text-sm text-slate-600 mb-2">
                        Use this structured data to communicate the exact issue, SKU, and transaction ID to Amazon Support.
                    </p>

                    <div class="bg-gray-800 text-green-400 p-4 rounded-lg relative">
                        <pre id="claim-json-data" class="text-xs"></pre>
                        <button
                            onclick="copyClaimData()"
                            class="absolute top-2 right-2 p-2 bg-gray-700 rounded-lg text-white hover:bg-gray-600 transition text-xs font-medium"
                        >
                            <span id="copy-btn-text">Copy JSON</span>
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 2: File on Seller Central
                    </h3>
                    <ol class="list-decimal list-inside space-y-3 text-sm text-slate-700">
                        <li>
                            Go to <strong>Seller Central Help</strong> ‚Üí
                            <a
                                href="https://sellercentral.amazon.com/gp/contact-us/performance/ref=ag_contactus_foot_perfd_cont_201642190"
                                target="_blank"
                                class="text-blue-600 hover:underline font-medium"
                            >
                                Contact Us
                            </a>
                        </li>
                        <li>Select ‚ÄúSelling on Amazon Issue‚Äù ‚Üí ‚ÄúFBA Issue‚Äù ‚Üí <strong>Investigate Missing / Damaged Units</strong>.</li>
                        <li>Paste the JSON directly into the case description.</li>
                        <li>Attach the original CSV as evidence.</li>
                        <li>Submit the case and track reimbursements.</li>
                    </ol>
                </div>
            </div>

            <div class="mt-10">
                <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                    Step 3: Copy/Paste Ready-Made Amazon Case Messages
                </h3>

                <p class="text-sm text-slate-600 mb-4">
                    These are ready-to-send message templates for each claim. Paste into Seller Central.
                </p>

                <div
                    id="claim-messages"
                    class="space-y-4 max-h-64 overflow-y-auto text-left bg-gray-50 p-4 rounded-xl border border-gray-200"
                ></div>
            </div>

            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="rh-primary-btn mt-10 w-full py-3 text-white rounded-xl font-bold shadow-lg transition"
            >
                I Understand ‚Äì Close Guide
            </button>
        </div>
    </div>

<!-- AUTH MODALS -->
<div id="auth-overlay"
     class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4"
     onclick="closeModalOnOutsideClick(event)">
    
    <div id="login-modal"
         class="hidden bg-white p-8 rounded-2xl max-w-md w-full shadow-xl relative"
         onclick="event.stopPropagation()">

        <button
            onclick="closeAuthModals()"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            ‚úï
        </button>

        <h2 class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">Log In</h2>
        <p class="text-sm text-gray-600 mb-6">Access your FBA Money Scout dashboard</p>

        <input id="login-email"
               type="email"
               placeholder="Email"
               class="w-full mb-3 p-3 rounded-lg border border-gray-300 rh-focus">

        <input id="login-password"
               type="password"
               placeholder="Password"
               class="w-full mb-4 p-3 rounded-lg border border-gray-300 rh-focus">

        <button onclick="loginUser()"
                class="rh-primary-btn w-full py-3 text-white rounded-xl font-bold">
            Log In
        </button>

        <p class="text-sm mt-4 text-center text-gray-500">
            Need an account?
            <span onclick="switchToSignup()"
                class="text-[var(--rh-primary)] font-semibold cursor-pointer">
                Create one
            </span>
        </p>
    </div>

    <div id="signup-modal"
         class="hidden bg-white p-8 rounded-2xl max-w-md w-full shadow-xl relative"
         onclick="event.stopPropagation()">

        <button
            onclick="closeAuthModals()"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            ‚úï
        </button>

        <h2 class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">Create Account</h2>
        <p class="text-sm text-gray-600 mb-6">Start tracking your reimbursements</p>

        <input id="signup-email"
               type="email"
               placeholder="Email"
               class="w-full mb-3 p-3 rounded-lg border border-gray-300 rh-focus">

        <input id="signup-password"
               type="password"
               placeholder="Password"
               class="w-full mb-4 p-3 rounded-lg border border-gray-300 rh-focus">

        <button onclick="signupUser()"
                class="rh-primary-btn w-full py-3 text-white rounded-xl font-bold">
            Create Account
        </button>

        <p class="text-sm mt-4 text-center text-gray-500">
            Already have an account?
            <span onclick="switchToLogin()"
                class="text-[var(--rh-primary)] font-semibold cursor-pointer">
                Log in
            </span>
        </p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        collection,
        query,
        orderBy,
        serverTimestamp,
        runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const AUDIT_LIMIT = 5;
    let db, auth;
    let userId = null;
    let auditsUsed = 0;
    let isPremium = false;
    let isAuthReady = false;
    let uploadedFileContent = null;
    let selectedFileName = "";
    let currentClaimsData = [];
    let currentTotalValue = 0;
    let currentClaimMessages = [];
// --- AUTH MODAL HANDLERS ---
window.openLoginModal = function() {
    document.getElementById('auth-overlay').classList.remove('hidden');
    document.getElementById('login-modal').classList.remove('hidden');
    document.getElementById('signup-modal').classList.add('hidden');
    // Clear file selection if login is required
    document.getElementById('csv-file').value = null; 
}

window.closeAuthModals = function() {
    document.getElementById('auth-overlay').classList.add('hidden');
    document.getElementById('login-modal').classList.add('hidden');
    document.getElementById('signup-modal').classList.add('hidden');
}

// You also need to define the modal switching functions used inside the modals
window.switchToSignup = function() {
    document.getElementById('login-modal').classList.add('hidden');
    document.getElementById('signup-modal').classList.remove('hidden');
}

window.switchToLogin = function() {
    document.getElementById('signup-modal').classList.add('hidden');
    document.getElementById('login-modal').classList.remove('hidden');
}

// Function to close any modal if the user clicks the dark background
window.closeModalOnOutsideClick = function(event) {
    if (event.target.id === 'auth-overlay' || event.target.id === 'upgrade-modal' || event.target.id === 'claim-filing-modal') {
        event.target.classList.add('hidden');
    }
}
 // --- USAGE DISPLAY HANDLER ---
window.updateUsageDisplay = function () {
    const auditsUsedElement = document.getElementById('audits-used');
    const auditsRemainingElement = document.getElementById('audits-remaining');
    const usageBar = document.getElementById('usage-bar');
    const freeUsesDisplay = document.getElementById('free-uses-display');
    const subscriptionStatusElement = document.getElementById('subscription-status');
    const auditButton = document.getElementById('audit-button');
    
    // 1. Calculate remaining and percentage
    const remaining = Math.max(0, AUDIT_LIMIT - auditsUsed);
    const percentage = (auditsUsed / AUDIT_LIMIT) * 100;
    const isOverLimit = auditsUsed >= AUDIT_LIMIT && !isPremium;

    // 2. Update Subscription Status text
    if (subscriptionStatusElement) {
        subscriptionStatusElement.textContent = isPremium ? 'Pro Hunter (Unlimited)' : 'Trial User';
    }

    // 3. Update text fields (e.g., "3 / 5" used)
    if (auditsUsedElement) {
        auditsUsedElement.textContent = auditsUsed;
    }
    if (auditsRemainingElement) {
        auditsRemainingElement.textContent = remaining;
    }

    if (freeUsesDisplay) {
        if (isPremium) {
             freeUsesDisplay.textContent = "You have Unlimited Audits!";
        } else if (isOverLimit) {
            freeUsesDisplay.textContent = `You have used all ${AUDIT_LIMIT} free audits. Please upgrade for more!`;
        } else {
            freeUsesDisplay.textContent = `Your first ${remaining} audits are free.`;
        }
    }

    // 4. Update Progress Bar
    if (usageBar) {
        // Sets the width of the blue bar based on usage
        usageBar.style.width = `${Math.min(100, percentage)}%`; 
    }
    
    // 5. Update Audit Button state (Disable if they are out of audits)
    if (auditButton) {
        auditButton.disabled = isOverLimit;
        auditButton.textContent = isOverLimit ? 'Upgrade to Audit' : 'Audit Report';
    }
}   
// ----------------------------
    const API_BASE_URL = "https://refundhunter-backend.onrender.com";
    const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";

    const firebaseConfig = {
      apiKey: "AIzaSyAwPijZtG54zmRN_vfdFwF_aURZiYJR58s",
      authDomain: "fbamoneyscout.firebaseapp.com",
      projectId: "fbamoneyscout-e0487",
      storageBucket: "fbamoneyscout.firebasestorage.app",
      messagingSenderId: "1072177597124",
      appId: "1:1072177597124:web:bee84507aa63dd827f9791"
    };

    // ‚úÖ Proper Firebase initialization
    const firebaseApp = initializeApp(firebaseConfig);
    auth = getAuth(firebaseApp);
    db = getFirestore(firebaseApp);

    // --- AUTH MODALS ---
    window.openLoginModal = function () {
        document.getElementById("auth-overlay").classList.remove("hidden");
        document.getElementById("login-modal").classList.remove("hidden");
        document.getElementById("signup-modal").classList.add("hidden");
    };

    window.openSignupModal = function () {
        document.getElementById("auth-overlay").classList.remove("hidden");
        document.getElementById("signup-modal").classList.remove("hidden");
        document.getElementById("login-modal").classList.add("hidden");
    };

    window.switchToSignup = function () {
        document.getElementById("login-modal").classList.add("hidden");
        document.getElementById("signup-modal").classList.remove("hidden");
    };

    window.switchToLogin = function () {
        document.getElementById("signup-modal").classList.add("hidden");
        document.getElementById("login-modal").classList.remove("hidden");
    };

    window.closeAuthModals = function () {
        document.getElementById("auth-overlay").classList.add("hidden");
        document.getElementById("login-modal").classList.add("hidden");
        document.getElementById("signup-modal").classList.add("hidden");
    };

    window.loginUser = async function () {
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value.trim();

        try {
            await signInWithEmailAndPassword(auth, email, password);
            closeAuthModals();
        } catch (err) {
            alert("Login failed: " + err.message);
        }
    };

    window.signupUser = async function () {
        const email = document.getElementById("signup-email").value.trim();
        const password = document.getElementById("signup-password").value.trim();

        try {
            await createUserWithEmailAndPassword(auth, email, password);
            closeAuthModals();
        } catch (err) {
            alert("Signup failed: " + err.message);
        }
    };

    window.logoutUser = async function () {
        try {
            await auth.signOut();
        } catch (err) {
            alert("Logout failed: " + err.message);
        }
    };
    function initFirebase() {
        try {
            console.log("Firebase Init: App ID =", appId);
            console.log("Firebase Init: Auth ready =", !!auth);
            console.log("Firebase Init: DB ready =", !!db);

            onAuthStateChanged(auth, async (user) => {
                const loginBtn = document.getElementById("nav-login-btn");
                const logoutBtn = document.getElementById("nav-logout-btn");

                if (user) {
                    loginBtn.classList.add("hidden");
                    logoutBtn.classList.remove("hidden");
                    userId = user.uid;
                    if (!isAuthReady) {
                        isAuthReady = true;
                        loadUserDataAndHistory();
                    }
                } else {
                    userId = null;
                    loginBtn.classList.remove("hidden");
                    logoutBtn.classList.add("hidden");
                }
            });
        } catch (e) {
            console.error("Firebase init failed:", e);
            alert("Firebase failed to initialize. Check your configuration.");
        }
    }
    // --- USER DATA & HISTORY LOADER ---
// This function runs once the user is confirmed logged in.
async function loadUserDataAndHistory() {
    // 1. Set up the Real-time Listener for Audit Limits
    const limitsDocRef = doc(db, 'artifacts/fbamoneyscout/users', userId, 'user_data', 'limits');
    
    // onSnapshot is the "listener" that watches the database in real-time.
    onSnapshot(limitsDocRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            // Update the global variables with the latest numbers from the database
            auditsUsed = data.auditsUsed || 0;
            isPremium = data.isPremium || false;
        } else {
            // First time user, set defaults
            auditsUsed = 0;
            isPremium = false;
        }
        
        // **CRITICAL STEP:** Call the display function to show the new numbers
        updateUsageDisplay(); 
        
    }, (error) => {
        console.error("Error listening to limits: ", error);
        // Fallback on error
        auditsUsed = AUDIT_LIMIT; 
        updateUsageDisplay(); 
    });

    // 2. You can keep any existing code here, like fetching history.
    // fetchAuditHistory(); 
}
    function loadUserDataAndHistory() {
        if (!db || !userId) return;
        console.log("Loading user data and history for user:", userId);

        const limitsDocRef = doc(db, `artifacts/fbamoneyscout/users/${userId}/user_data/limits`);

        onSnapshot(
            limitsDocRef,
            (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    auditsUsed = data.auditsUsed || 0;
                    isPremium = data.isPremium || false;
                } else {
                    auditsUsed = 0;
                    isPremium = false;
                    setDoc(
                        limitsDocRef,
                        { auditsUsed: 0, isPremium: false },
                        { merge: true }
                    ).catch(console.error);
                }
                updateAuditButton();
                updateProfileDisplay();
            },
            (error) => {
                console.error("Error reading limits:", error);
                document.getElementById("status-message").textContent =
                    "Error reading free uses limit.";
            }
        );

        const historyCollectionRef = collection(
            db,
            `artifacts/fbamoneyscout/users/${userId}/user_data/audit_history`
        );
        const historyQuery = query(historyCollectionRef, orderBy("createdAt", "desc"));

        onSnapshot(
            historyQuery,
            (snapshot) => {
                console.log("History snapshot received. Documents:", snapshot.docs.length);
                renderHistory(snapshot.docs);
            },
            (error) => {
                console.error("Error reading history:", error);
                document.getElementById("history-loading").textContent =
                    "Error loading history.";
            }
        );
    }

    async function saveAuditResult(fileName, claims, totalValue) {
        if (!db || !userId) return;

        try {
            const historyCollectionRef = collection(
                db,
                `artifacts/fbamoneyscout/users/${userId}/user_data/audit_history`
            );

            await setDoc(doc(historyCollectionRef), {
                fileName: fileName,
                claimsCount: claims.length,
                totalEstimatedValue: totalValue,
                claims: JSON.stringify(claims),
                createdAt: serverTimestamp()
            });

            console.log("Audit result saved successfully.");
        } catch (error) {
            console.error("Failed to save audit result:", error);
            document.getElementById("status-message").textContent =
                "Audit saved locally but failed to save to history.";
        }
    }

    async function incrementAuditCounter() {
        if (!db || !userId) return false;

        const limitsDocRef = doc(db, `artifacts/fbamoneyscout/users/${userId}/user_data/limits`);

        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(limitsDocRef);

                if (!docSnap.exists()) {
                    transaction.set(limitsDocRef, {
                        auditsUsed: 1,
                        isPremium: false
                    });
                    auditsUsed = 1;
                    return;
                }

                const data = docSnap.data();

                if (data.isPremium === true) {
                    auditsUsed = 0;
                    return;
                }

                const newCount = (data.auditsUsed || 0) + 1;
                transaction.update(limitsDocRef, { auditsUsed: newCount });
                auditsUsed = newCount;
            });

            updateAuditButton();
            updateProfileDisplay();
            return true;

        } catch (error) {
            console.error("Transaction failed (incrementAuditCounter):", error);
            document.getElementById("status-message").textContent =
                "Fatal Error: Failed to track usage.";
            return false;
        }
    }

    function updateProfileDisplay() {
        try {
            const auditsUsedEl = document.getElementById("audits-used");
            const auditsRemainingEl = document.getElementById("audits-remaining");
            const usageBarEl = document.getElementById("usage-bar");
            const subscriptionStatusEl = document.getElementById("subscription-status");

            const used = auditsUsed || 0;
            const remaining = AUDIT_LIMIT - used;
            const isPro = isPremium || false;

            if (auditsUsedEl) auditsUsedEl.textContent = used;
            if (auditsRemainingEl) auditsRemainingEl.textContent = remaining;

            if (usageBarEl) {
                const pct = isPro ? 100 : Math.min((used / AUDIT_LIMIT) * 100, 100);
                usageBarEl.style.width = pct + "%";
            }

            if (subscriptionStatusEl) {
                subscriptionStatusEl.textContent = isPro
                    ? "PRO Hunter (Unlimited)"
                    : "Trial User";
            }

        } catch (err) {
            console.error("updateProfileDisplay failed:", err);
        }
    }

    function renderHistory(docs) {
        const listContainer = document.getElementById("history-list");
        listContainer.innerHTML = "";
        document.getElementById("history-loading").classList.add("hidden");

        if (docs.length === 0) {
            listContainer.innerHTML =
                '<p class="text-slate-500 italic">No previous audits found. Upload your first report!</p>';
            return;
        }

        docs.forEach((docSnap) => {
            const data = docSnap.data();
            const date = data.createdAt
                ? new Date(data.createdAt.seconds * 1000).toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "short",
                      day: "numeric"
                  })
                : "N/A";

            const historyItem = document.createElement("div");
            historyItem.className =
                "bg-white p-4 rounded-xl shadow border border-gray-200 flex justify-between items-center hover:shadow-lg transition cursor-pointer";
            historyItem.onclick = () => viewHistoryItem(docSnap.id);

            historyItem.innerHTML = `
                <div>
                    <p class="font-semibold text-slate-800">${data.fileName || "Audit Report"}</p>
                    <p class="text-sm text-slate-600">
                        Audited on ${date} &bull; ${data.claimsCount} claims found
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-extrabold text-[var(--rh-success)]">
                        $${(data.totalEstimatedValue || 0).toFixed(2)}
                    </p>
                    <span class="text-xs text-[var(--rh-primary)] hover:underline mt-1">
                        View Details
                    </span>
                </div>
            `;
            listContainer.appendChild(historyItem);
        });
    }

    window.viewHistoryItem = function (docId) {
        const docRef = doc(
            db,
            `artifacts/fbamoneyscout/users/${userId}/user_data/audit_history/${docId}`
        );

        onSnapshot(
            docRef,
            (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const claims = JSON.parse(data.claims || "[]");

                    currentClaimsData = claims;
                    currentTotalValue = data.totalEstimatedValue || 0;

                    displayClaims(claims, data.totalEstimatedValue || 0, data.fileName);
                }
            },
            (error) => {
                console.error("Failed to load history item:", error);
                document.getElementById("status-message").textContent =
                    "Failed to load audit details.";
            }
        );
    };

    // üîí Require login before file select
    window.requireLoginThenSelectFile = function (event) {
        if (!auth.currentUser) {
            openLoginModal();
            return;
        }
        handleFileSelect(event);
    };

    window.handleFileSelect = function (event) {
        console.log("File select triggered");

        const file = event.target.files[0];
        const fileNameDisplay = document.getElementById("file-name-display");

        document.getElementById("results-area").classList.add("hidden");

        if (!file) {
            uploadedFileContent = null;
            fileNameDisplay.textContent = "No file selected.";
            updateAuditButton();
            return;
        }

        if (file.type !== "text/csv" && !file.name.endsWith(".csv")) {
            fileNameDisplay.textContent = "Error: Please upload a .csv file only.";
            fileNameDisplay.classList.add("text-red-500");
            uploadedFileContent = null;
            updateAuditButton();
            return;
        }

        selectedFileName = file.name;
        fileNameDisplay.textContent = `File Selected: ${selectedFileName}`;
        fileNameDisplay.classList.remove("text-red-500");

        const reader = new FileReader();

        reader.onload = (e) => {
            uploadedFileContent = e.target.result;
            updateAuditButton();
        };

        reader.onerror = (e) => {
            console.error("FileReader error", e);
            uploadedFileContent = null;
            fileNameDisplay.textContent = "Error reading file.";
            fileNameDisplay.classList.add("text-red-500");
            updateAuditButton();
        };

        reader.readAsText(file);
    };

    function updateAuditButton() {
        const auditButton = document.getElementById("audit-button");
        const freeUsesDisplay = document.getElementById("free-uses-display");

        const used = auditsUsed;
        const remaining = AUDIT_LIMIT - used;
        const isFileReady = uploadedFileContent !== null;

        auditButton.onclick = null;

        if (isPremium) {
            auditButton.textContent = "Run Audit (PRO Unlimited)";
            auditButton.disabled = !isFileReady;

            if (isFileReady) {
                auditButton.onclick = processAuditWrapper;
            }

            if (freeUsesDisplay) {
                freeUsesDisplay.innerHTML =
                    'You are a <strong>PRO Hunter</strong>. Unlimited audits unlocked!';
            }

            return;
        }

        if (remaining > 0) {
            auditButton.textContent = `Audit Report (${remaining}/${AUDIT_LIMIT} FREE Uses Remaining)`;
            auditButton.disabled = !isFileReady;

            if (isFileReady) {
                auditButton.onclick = processAuditWrapper;
            }

            if (freeUsesDisplay) {
                freeUsesDisplay.innerHTML = `
                    Your first <strong>${AUDIT_LIMIT}</strong> audits are free.
                    You have <strong>${remaining}</strong> remaining.
                `;
            }

            return;
        }

        auditButton.textContent = "Audit Report (Upgrade Required)";
        auditButton.disabled = false;
        auditButton.onclick = () => showUpgradeModal("audit_monthly");

        if (freeUsesDisplay) {
            freeUsesDisplay.innerHTML = `
                You have used your <strong>${AUDIT_LIMIT}</strong> free audits.
                Please upgrade below for unlimited use.
            `;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        initFirebase();
        const auditButton = document.getElementById("audit-button");
        if (auditButton) {
            auditButton.onclick = processAuditWrapper;
        }
    });

    function processAuditWrapper() {
        if (!userId) {
            openLoginModal();
            return;
        }

        if (!isPremium && auditsUsed >= AUDIT_LIMIT) {
            showUpgradeModal("audit_monthly");
            return;
        }

        if (uploadedFileContent) {
            processAudit(uploadedFileContent, selectedFileName);
        }
    }

    function finishAuditDisplay() {
        document.getElementById("loading-indicator").classList.add("hidden");
        document.getElementById("upload-section").classList.remove("hidden");

        displayClaims(currentClaimsData, currentTotalValue, selectedFileName);

        uploadedFileContent = null;
        selectedFileName = "";
        document.getElementById("file-name-display").textContent =
            "Click to select your FBA Inventory Ledger or Daily Inventory Report (CSV file only)";
        document.getElementById("csv-file").value = "";
        document.getElementById("audit-button").disabled = true;

        document.getElementById("status-message").textContent =
            "Audit Complete. Ready for next report.";
    }

    window.closeModalOnOutsideClick = function (event) {
        if (event.target.id === "upgrade-modal" || event.target.id === "claim-filing-modal" || event.target.id === "auth-overlay") {
            document.getElementById("upgrade-modal").classList.add("hidden");
            document.getElementById("claim-filing-modal").classList.add("hidden");
            document.getElementById("auth-overlay").classList.add("hidden");
        }
    };

    window.showUpgradeModal = function (productName) {
        const modal = document.getElementById("upgrade-modal");
        const title = document.getElementById("modal-title");
        const price = document.getElementById("modal-price");
        const description = document.getElementById("modal-description");
        const checkoutLink = document.getElementById("modal-checkout-link");
        const modalIconPath = modal.querySelector("#modal-icon path");

        const productDetails =
            {
                audit_monthly: {
                    title: "Unlock Unlimited Audits",
                    price: "$199 / Month",
                    description:
                        "Go Pro and get unlimited access to FBA Money Scout. Never miss a claim again.",
                    iconPath:
                        "M12 1c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zM10 13l2-2 2 2M10 11l2-2 2 2",
                    url: `https://buy.stripe.com/bJe3cuarVa2f4Buc2W7EQ00`
                },
                audit_single: {
                    title: "Purchase Single Audit Boost",
                    price: "$99 One-Time",
                    description:
                        "Purchase a single audit report immediately. Great for occasional use or one large report.",
                    iconPath: "M12 6v6m0 0v6m0-6h6m-6 0H6",
                    url: `https://buy.stripe.com/28EbJ0bvZ0rF4BuaYS7EQ01`
                }
            }[productName] || null;

        if (!productDetails) return;

        title.textContent = productDetails.title;
        price.textContent = productDetails.price;
        description.textContent = productDetails.description;
        checkoutLink.href = productDetails.url;

        if (modalIconPath) {
            modalIconPath.setAttribute("d", productDetails.iconPath);
        }

        modal.classList.remove("hidden");
    };

    window.showClaimFilingModal = function (claims, totalValue) {
        const modal = document.getElementById("claim-filing-modal");
        const claimCountDisplay = document.getElementById("filing-claim-count");
        const claimValueDisplay = document.getElementById("filing-claim-value");
        const jsonDataBlock = document.getElementById("claim-json-data");
        const copyBtnText = document.getElementById("copy-btn-text");
        const messagesContainer = document.getElementById("claim-messages");

        claimCountDisplay.textContent = `${claims.length}`;
        claimValueDisplay.textContent = `$${totalValue.toFixed(2)}`;

        const jsonClaims = JSON.stringify(claims, null, 2);
        jsonDataBlock.textContent = jsonClaims;

        copyBtnText.textContent = "Copy JSON";

        if (messagesContainer) {
            messagesContainer.innerHTML = "";

            if (!currentClaimMessages || currentClaimMessages.length === 0) {
                messagesContainer.innerHTML =
                    "<p class='text-sm text-slate-500 italic'>No pre-written messages were generated for this audit. You can still use the JSON and filing steps above.</p>";
            } else {
                currentClaimMessages.forEach((msg, index) => {
                    const card = document.createElement("div");
                    card.className =
                        "bg-gray-50 border border-gray-200 rounded-lg p-3";

                    const skuLabel = msg.sku ? `SKU: ${msg.sku}` : "";
                    const reasonLabel = msg.reason ? `Reason: ${msg.reason}` : "";

                    card.innerHTML = `
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-slate-800">
                          Case Message #${index + 1}
                        </span>
                        <span class="text-xs text-slate-500">
                          ${skuLabel}
                          ${reasonLabel ? "&nbsp;&bull;&nbsp;" + reasonLabel : ""}
                        </span>
                      </div>
                      <textarea
                        class="w-full text-xs p-2 rounded-md border border-gray-300 bg-white"
                        rows="5"
                        readonly
                      >${(msg.message || "").trim()}</textarea>
                    `;

                    messagesContainer.appendChild(card);
                });
            }
        }

        modal.classList.remove("hidden");
    };

    window.copyClaimData = function () {
        const jsonDataBlock = document.getElementById("claim-json-data");
        const copyBtnText = document.getElementById("copy-btn-text");

        try {
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = jsonDataBlock.textContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand("copy");
            document.body.removeChild(tempTextArea);

            copyBtnText.textContent = "Copied!";
            setTimeout(() => {
                copyBtnText.textContent = "Copy JSON";
            }, 2000);
        } catch (err) {
            console.error("Failed to copy text: ", err);
            copyBtnText.textContent = "Error Copying!";
        }
    };

    async function processAudit(csvContent, fileName) {
        if (!isPremium && auditsUsed >= AUDIT_LIMIT) {
            showUpgradeModal("audit_monthly");
            return;
        }

        document.getElementById("upload-section").classList.add("hidden");
        document.getElementById("loading-indicator").classList.remove("hidden");
        document.getElementById("results-area").classList.add("hidden");
        document.getElementById("status-message").textContent =
            `Analyzing ${fileName}...`;

        try {
            const response = await fetch(`${API_BASE_URL}/api/audit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    csvContent,
                    fileName,
                    userId: userId || "anonymous"
                })
            });

            if (!response.ok) {
                throw new Error(`Backend responded with status ${response.status}`);
            }

            const data = await response.json();

            currentClaimsData = data.claims || [];
            currentTotalValue = data.totalEstimatedValue || 0;
            currentClaimMessages = data.messages || [];

            if (!isPremium) {
                await incrementAuditCounter();
            }
            await saveAuditResult(fileName, currentClaimsData, currentTotalValue);
        } catch (err) {
            console.error("BACKEND ERROR:", err);
            alert("Error analyzing your report. Please try again.");

            currentClaimsData = [];
            currentTotalValue = 0;

            document.getElementById("loading-indicator").classList.add("hidden");
            document.getElementById("upload-section").classList.remove("hidden");
            document.getElementById("status-message").textContent =
                "Audit Failed: Connection or server error.";
            return;
        }

        finishAuditDisplay();
    }

    let lastClaimsData = null;

    function renderClaimChart(data, total) {
        const canvas = document.getElementById("claim-chart");
        const ctx = canvas.getContext("2d");

        lastClaimsData = { data, total };

        canvas.width = canvas.offsetWidth;
        canvas.height = 250;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (total === 0 || !Object.keys(data).length) {
            ctx.fillStyle = "#94a3b8";
            ctx.font = "16px Inter";
            ctx.textAlign = "center";
            ctx.fillText("No claims found to chart.", canvas.width / 2, canvas.height / 2);
            return;
        }

        const reasons = Object.keys(data);
        const values = Object.values(data);
        const numBars = reasons.length;

        const colors = ["#FE9900", "#4BB543", "#3498DB", "#E74C3C", "#9B59B6", "#F39C12"];
        const darkText = "#1f2937";
        const lightGrey = "#e5e7eb";

        const padding = 30;
        const chartHeight = canvas.height - padding * 2;
        const chartWidth = canvas.width - padding * 2;
        const barSpacing = 15;
        const barWidth = (chartWidth - (numBars - 1) * barSpacing) / numBars;
        const maxValue = Math.max(...values) * 1.1;

        ctx.strokeStyle = lightGrey;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, canvas.height - padding);
        ctx.lineTo(canvas.width - padding, canvas.height - padding);
        ctx.stroke();

        for (let i = 0; i < numBars; i++) {
            const value = values[i];
            const reason = reasons[i];
            const x = padding + i * (barWidth + barSpacing);
            const barHeight = (value / maxValue) * chartHeight;
            const y = canvas.height - padding - barHeight;
            const barXCenter = x + barWidth / 2;

            ctx.fillStyle = colors[i % colors.length];
            ctx.fillRect(x, y, barWidth, barHeight);

            ctx.fillStyle = darkText;
            ctx.font = "11px Inter";
            ctx.textAlign = "center";
            ctx.fillText(reason, barXCenter, canvas.height - 10);

            ctx.fillStyle = darkText;
            ctx.font = "14px Inter bold";
            ctx.fillText(`$${value.toFixed(0)}`, barXCenter, y - 5);
        }
    }

    window.addEventListener("resize", () => {
        const resultsArea = document.getElementById("results-area");
        if (!resultsArea.classList.contains("hidden") && lastClaimsData) {
            renderClaimChart(lastClaimsData.data, lastClaimsData.total);
        }
    });

    function displayClaims(claims, totalEstimatedValue, auditFileName) {
        const resultsArea = document.getElementById("results-area");
        const listContainer = document.getElementById("claim-list");
        const claimCountDisplay = document.getElementById("claim-count");
        const noClaimsMessage = document.getElementById("no-claims-found");

        resultsArea.classList.remove("hidden");
        resultsArea.querySelector("h2").innerHTML = `
            <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">
                ${claims.length}
            </span>
            Actionable Reimbursement Claims Found in: ${auditFileName}
        `;

        listContainer.innerHTML = "";
        const valueByReason = {};

        if (claims && claims.length > 0) {
            claimCountDisplay.textContent = claims.length;
            noClaimsMessage.classList.add("hidden");

            claims.forEach((claim) => {
                const value = parseFloat(claim.estimatedValue) || 0;
                const reason = claim.claimReason || "Unspecified Claim";

                valueByReason[reason] = (valueByReason[reason] || 0) + value;

                const claimElement = document.createElement("div");
                claimElement.className =
                    "bg-gray-50 p-4 rounded-xl border border-gray-200 hover:bg-gray-100 transition";
                claimElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-bold text-slate-800">${reason}</span>
                        <span class="text-xl font-extrabold text-[var(--rh-success)]">
                            $${value.toFixed(2)}
                        </span>
                    </div>
                    <p class="text-sm text-slate-600">
                        <strong>SKU:</strong> ${claim.sku || "N/A"} &bull;
                        <strong>Qty:</strong> ${claim.quantity || 1} &bull;
                        <strong>Ref ID:</strong> ${claim.amazonTransactionId || "None"}
                    </p>
                `;
                listContainer.appendChild(claimElement);
            });

            renderClaimChart(valueByReason, totalEstimatedValue);

            const summaryElement = document.createElement("div");
            summaryElement.className =
                "bg-white p-6 rounded-xl border-4 border-[var(--rh-primary)] shadow-inner mb-6";
            summaryElement.innerHTML = `
                <p class="text-xl font-bold text-[var(--rh-dark)] flex justify-between">
                    <span>Total Estimated Reimbursement Value:</span> 
                    <span class="text-3xl text-[var(--rh-success)] font-extrabold">
                        $${totalEstimatedValue.toFixed(2)}
                    </span>
                </p>
                <p class="text-sm text-slate-500 mt-2">
                    This is the cash you can claim back by filing these reports.
                </p>
            `;
            listContainer.prepend(summaryElement);

            const fileClaimsButton = document.createElement("button");
            fileClaimsButton.id = "file-claims-btn";
            fileClaimsButton.className =
                "rh-primary-btn mt-6 w-full py-3 text-white rounded-xl font-bold shadow-lg transition";
            fileClaimsButton.textContent = `File ${claims.length} Claims Worth $${totalEstimatedValue.toFixed(2)}`;
            fileClaimsButton.onclick = () =>
                showClaimFilingModal(currentClaimsData, currentTotalValue);

            listContainer.appendChild(fileClaimsButton);
        } else {
            claimCountDisplay.textContent = "0";
            noClaimsMessage.classList.remove("hidden");
            renderClaimChart({}, 0);
        }
    }
</script>
</body>
</html>






