<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClaimPilotPro – Amazon FBA Reimbursement Audit</title>
    
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rh-primary': '#0F766E',   // teal
                        'rh-dark': '#020617',      // near-black
                        'rh-success': '#22C55E',   // green
                        'rh-bg-light': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                },
            },
        }
    </script>

    <style>
        :root {
            --rh-primary: #0F766E;
            --rh-success: #22C55E;
            --rh-dark: #020617;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f8fafc;
        }

        .rh-primary-btn {
            background-color: var(--rh-primary);
            box-shadow: 0 4px 6px -1px rgba(15, 118, 110, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .rh-primary-btn:hover:not(:disabled) {
            background-color: #115e59;
            transform: translateY(-1px);
        }

        .rh-secondary-btn {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .rh-secondary-btn:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        .rh-focus:focus {
            border-color: var(--rh-primary);
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.35);
            outline: none;
        }

        .main-card-shadow {
            box-shadow:
                0 10px 15px -3px rgba(15, 23, 42, 0.15),
                0 4px 6px -2px rgba(15, 23, 42, 0.1),
                inset 0 0 10px rgba(15, 23, 42, 0.02);
        }

        #claim-chart {
            width: 100%;
            height: 250px;
        }

        #claim-json-data {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="text-slate-800">

<!-- ======= NAVBAR ======= -->
<nav class="backdrop-blur-lg bg-white/80 border-b border-slate-200/70 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 lg:px-8 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-3 leading-tight">
            <div class="h-9 w-9 rounded-xl bg-[var(--rh-primary)]/10 border border-[var(--rh-primary)] flex items-center justify-center">
                <span class="text-[var(--rh-primary)] font-extrabold text-lg tracking-tight">CP</span>
            </div>
            <div class="flex flex-col">
                <span class="text-2xl font-extrabold text-[var(--rh-dark)] tracking-tight">
                    ClaimPilotPro
                    <span class="ml-1 h-2 w-2 bg-[var(--rh-success)] rounded-full inline-block opacity-80"></span>
                </span>
                <span class="text-xs text-slate-500">AI-powered Amazon FBA reimbursement audits</span>
            </div>
        </div>

        <div class="hidden md:flex items-center space-x-10 font-medium">
            <a href="#upload-section" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Dashboard
            </a>
            <a href="#history-area" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                History
            </a>
            <a href="#pricing" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Pricing
            </a>
            <a href="#profile-area" class="text-gray-600 hover:text-[var(--rh-primary)] transition-colors duration-200">
                Account
            </a>
        </div>

        <div class="flex items-center space-x-4">
            <button id="nav-login-btn"
                    class="text-[var(--rh-primary)] font-semibold hover:underline"
                    onclick="openLoginModal()">
                Log In
            </button>
            <button id="nav-logout-btn"
                    class="hidden text-gray-600 font-semibold hover:underline"
                    onclick="logoutUser()">
                Log Out
            </button>
            <button
                onclick="document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' })"
                class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-4 py-2 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                View Plans
            </button>
        </div>
    </div>
</nav>

<!-- HERO SECTION -->
<section class="w-full bg-white py-14 px-4 md:px-10 border-b border-gray-100">
    <div class="max-w-6xl mx-auto grid md:grid-cols-[1.2fr,0.9fr] gap-10 items-center">
        <div class="text-center md:text-left">
            <p class="inline-flex items-center px-3 py-1 rounded-full bg-teal-50 text-xs font-semibold text-teal-700 border border-teal-100 mb-4">
                <span class="h-1.5 w-1.5 rounded-full bg-teal-500 mr-2"></span>
                New · AI-powered FBA reimbursement assistant
            </p>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-[var(--rh-dark)] leading-tight">
                Recover hidden
                <span class="text-[var(--rh-primary)]">FBA cash</span>
                in minutes, not months.
            </h1>
            <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-xl">
                Upload your Amazon FBA inventory report and let ClaimPilotPro surface
                missed reimbursements – complete with claim-ready case language you can
                paste straight into Seller Central.
            </p>
            <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:gap-4 items-center">
                <button
                    onclick="document.getElementById('upload-section').scrollIntoView({ behavior: 'smooth' })"
                    class="rh-primary-btn px-6 py-3 text-white rounded-xl font-semibold shadow-lg flex items-center justify-center gap-2 w-full sm:w-auto"
                >
                    Start Free Audit
                    <span class="text-xs font-normal bg-white/10 px-2 py-0.5 rounded-full">
                        No card required · 5 free reports
                    </span>
                </button>
                <button
                    onclick="document.getElementById('history-area').scrollIntoView({ behavior: 'smooth' })"
                    class="px-5 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-medium hover:bg-slate-100 transition w-full sm:w-auto"
                >
                    View Demo Audit History
                </button>
            </div>
            <p class="mt-3 text-xs text-slate-500 flex items-center gap-2">
                <span class="inline-flex -space-x-2">
                    <span class="h-6 w-6 rounded-full bg-teal-500/20 border border-white"></span>
                    <span class="h-6 w-6 rounded-full bg-emerald-500/20 border border-white"></span>
                    <span class="h-6 w-6 rounded-full bg-sky-500/20 border border-white"></span>
                </span>
                Trusted workflow pattern used by 6- and 7-figure FBA operators
            </p>
        </div>

        <div class="hidden md:block">
            <div class="bg-slate-900 rounded-2xl p-5 shadow-2xl border border-slate-800 relative overflow-hidden">
                <div class="absolute inset-0 opacity-20 pointer-events-none"
                     style="background-image: radial-gradient(circle at 10% 20%, rgba(45,212,191,0.35), transparent 55%), radial-gradient(circle at 80% 0%, rgba(56,189,248,0.3), transparent 55%);">
                </div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xs uppercase tracking-[0.2em] text-teal-300/80">Live Audit Preview</p>
                        <span class="px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-300 text-[10px] font-semibold border border-emerald-400/40">
                            +$4,820.17 detected
                        </span>
                    </div>
                    <div class="space-y-3 text-xs text-slate-200/90 font-mono max-h-60 overflow-hidden">
                        <div class="flex justify-between">
                            <span class="text-slate-400">SKU-KITCHEN-SET</span>
                            <span class="text-emerald-400 font-semibold">+$742.80</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">SKU-PET-BUNDLE</span>
                            <span class="text-emerald-400 font-semibold">+$1,203.10</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">SKU-OUTDOOR-PRO</span>
                            <span class="text-emerald-400 font-semibold">+$2,874.27</span>
                        </div>
                        <hr class="border-slate-700/70 my-2" />
                        <p class="text-[11px] text-slate-400">
                            ClaimPilotPro parses your FBA inventory ledger, flags exceptions, and drafts
                            Amazon-ready messages referencing exact SKUs, quantities, and reference IDs.
                        </p>
                    </div>
                    <div class="mt-5 flex items-center justify-between text-[11px] text-slate-300/90">
                        <span>Report type: <span class="font-semibold text-slate-50">Inventory Ledger</span></span>
                        <span>Avg. time saved per audit: <span class="font-semibold text-emerald-400">2–4 hours</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- MAIN APPLICATION CONTAINER -->
<div class="min-h-screen flex flex-col items-center p-4">
    <!-- FILE UPLOAD AND ACTION AREA -->
    <main class="w-full max-w-2xl bg-white p-8 rounded-xl mt-10 main-card-shadow border border-gray-200">
        <div id="upload-section">
            <h2 class="text-2xl font-semibold mb-1 text-slate-900">
                1. Upload Your Amazon Report (.CSV)
            </h2>
            <p class="text-sm text-slate-500 mb-4">
                ClaimPilotPro currently supports FBA <span class="font-semibold">Inventory Ledger</span> and
                <span class="font-semibold">Daily Inventory History</span> reports.
            </p>
            <p id="status-message" class="text-sm text-gray-500 mb-4"></p>

            <div class="mt-2 mb-6 p-4 bg-teal-50/70 border border-teal-100 rounded-xl">
                <h3 class="font-semibold text-teal-900 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-teal-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10A8 8 0 114 4.582V4a1 1 0 112 0v4a1 1 0 01-1 1H1a1 1 0 110-2h2.101A6.002 6.002 0 1016 10a1 1 0 112 0z" clip-rule="evenodd" />
                    </svg>
                    Where to find your report:
                </h3>
                <ul class="list-disc list-inside text-sm text-teal-800 mt-2 space-y-1">
                    <li>Go to <strong>Amazon Seller Central</strong> → <strong>Reports → Fulfillment</strong>.</li>
                    <li>Download the <strong>Inventory Ledger Report</strong> or <strong>Daily Inventory History Report</strong>.</li>
                    <li>Set a reasonable date range; very large files may need to be split.</li>
                    <li>Ensure the file is saved as <strong>.CSV</strong> before uploading.</li>
                </ul>
            </div>

            <!-- DRAG & DROP FILE AREA -->
            <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-xl text-center hover:border-[var(--rh-primary)] transition duration-200 bg-slate-50/40">
                <label for="csv-file" class="cursor-pointer block py-4">
                    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4h-1"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 15l-3-3m0 0l-3 3m3-3v8"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600 font-medium" id="file-name-display">
                        Click to upload your FBA Inventory Ledger or Daily Inventory History report (.csv)
                    </p>
                    <p class="mt-1 text-[11px] text-slate-400">
                        We never store your raw report – it’s processed on the fly for this audit only.
                    </p>
                </label>
                <input 
                    type="file"
                    id="csv-file"
                    accept=".csv"
                    class="hidden"
                    onchange="requireLoginThenSelectFile(event)"
                />
            </div>

            <div class="flex items-center justify-between gap-4 flex-wrap">
                <button
                    id="audit-button"
                    class="rh-primary-btn px-8 py-3 text-white rounded-xl font-bold shadow-lg transition disabled:opacity-50"
                    disabled
                >
                    Audit Report (Loading...)
                </button>
                <a href="#pricing" class="text-sm text-[var(--rh-primary)] hover:underline font-medium">
                    See pricing & upgrade options
                </a>
            </div>

            <p class="text-xs text-gray-500 mt-4">
                Note: ClaimPilotPro analyzes patterns to highlight likely reimbursement opportunities. Always review
                claims and comply with Amazon’s TOS when filing.
            </p>
        </div>
        
        <div id="loading-indicator" class="hidden text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-[var(--rh-primary)] border-t-transparent mx-auto mb-4"></div>
            <p class="text-slate-700 font-medium">
                Analyzing thousands of rows for discrepancies... this may take a moment.
            </p>
        </div>
    </main>
    
    <!-- RESULTS DISPLAY AREA -->
    <section
        id="results-area"
        class="hidden w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-3xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">0</span>
            Actionable Reimbursement Claims Found
        </h2>
        
        <div id="chart-container" class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
            <h3 class="text-xl font-semibold text-slate-800 mb-4">
                Claim Value Breakdown by Reason
            </h3>
            <canvas id="claim-chart"></canvas>
        </div>
        
        <div id="claim-list" class="space-y-4"></div>

        <div
            id="no-claims-found"
            class="hidden bg-green-50 p-4 rounded-lg border border-green-200 mt-4"
        >
            <p class="text-green-700 font-medium">
                Great news! This report shows no obvious discrepancies that warrant a reimbursement claim.
            </p>
        </div>
    </section>

    <!-- PROFILE / USAGE SECTION -->
    <section
        id="profile-area"
        class="w-full max-w-4xl mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
    >
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Your Profile & Usage
        </h2>

        <div class="grid md:grid-cols-2 gap-6 mt-4">
            <div class="bg-teal-50 p-5 rounded-xl border border-teal-100">
                <h3 class="font-semibold text-lg text-teal-900 mb-2">Audit Limits</h3>
                <p class="text-4xl font-extrabold text-teal-700 mb-3" id="usage-display">
                    <span id="audits-used">0</span> / 5
                    <span class="text-base font-normal text-teal-600">Free Audits Used</span>
                </p>
                <div id="usage-progress" class="w-full bg-teal-100 rounded-full h-2.5">
                    <div id="usage-bar" class="bg-teal-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-sm text-teal-800 mt-2">
                    <span id="audits-remaining">5</span> audits remaining before an upgrade is recommended.
                </p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-gray-300 shadow">
                <h3 class="font-semibold text-lg text-slate-800 mb-2">Subscription Status</h3>
                <p class="text-xl font-bold text-gray-700" id="subscription-status">Trial User</p>
                <p class="text-sm text-slate-500 mt-1 mb-4">
                    Your ClaimPilotPro trial includes <strong>5 free audits</strong> so you can validate your recovered cash
                    before upgrading.
                </p>
                <button
                    onclick="showUpgradeModal('audit_monthly')"
                    class="rh-primary-btn px-4 py-2 text-sm text-white rounded-lg font-medium"
                >
                    Manage Subscription / Upgrade
                </button>
            </div>
        </div>
    </section>

    <!-- HISTORY DISPLAY AREA -->
    <section id="history-area" class="w-full max-w-4xl mt-10 p-6">
        <h2 class="text-2xl font-bold text-[var(--rh-dark)] mb-1">Audit History</h2>
        <p class="text-sm text-slate-500 mb-3">
            Every completed audit is saved here so you can revisit high-value claims, re-export data, and compare performance over time.
        </p>
        <div id="history-list" class="space-y-4">
            <p id="history-loading" class="text-slate-500 italic">
                Loading previous audits...
            </p>
        </div>
    </section>

    <!-- PRICING SECTION -->
    <section id="pricing" class="py-16 bg-white mt-10 w-full border-t border-gray-200">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <h2 class="text-3xl font-bold mb-3 text-slate-900">
                Stop Letting Amazon Keep Your Money
            </h2>
            <p id="free-uses-display" class="text-xl text-slate-600 mb-12">
                Your first 5 audits with ClaimPilotPro are free.
            </p>

            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <!-- Trial Plan -->
                <div class="bg-gray-50 p-6 rounded-2xl border-2 border-gray-200 flex flex-col justify-between">
                    <div>
                        <p class="text-lg font-bold text-gray-700 mb-4">Trial Audit</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">FREE</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            Perfect to validate your first reimbursements
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                5 Full-Report AI Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>
                    <button
                        class="mt-8 w-full py-3 rounded-xl bg-gray-200 text-gray-500 font-bold cursor-default opacity-80"
                        disabled
                    >
                        Currently Active
                    </button>
                </div>

                <!-- Single Audit Plan -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border-2 border-gray-200 flex flex-col justify-between hover:border-teal-400 transition">
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">Single Audit Boost</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$99</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            One-time purchase for a high-stakes report
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                1 Full-Report Audit
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center text-slate-400">
                                <span class="text-red-500 mr-2 font-bold text-lg">&times;</span>
                                Auto-Claim Filing
                            </li>
                        </ul>
                    </div>

                    <button
                        onclick="startPurchase('https://buy.stripe.com/28EbJ0bvZ0rF4BuaYS7EQ01')"
                        class="mt-8 w-full py-3 rounded-xl rh-secondary-btn font-bold">
                        Purchase Single Audit
                    </button>
                </div>

                <!-- Pro Monthly Plan -->
                <div class="relative bg-white p-6 rounded-2xl shadow-2xl border-4 border-[var(--rh-primary)] scale-[1.03] flex flex-col justify-between">
                    <div class="absolute top-0 right-0 -mt-3 -mr-3 bg-emerald-500 text-white text-xs font-bold py-1 px-3 rounded-full uppercase shadow-md">
                        Best for Pros
                    </div>
                    <div>
                        <p class="text-lg font-bold text-slate-800 mb-4">ClaimPilotPro Monthly</p>
                        <p class="text-5xl font-extrabold text-slate-900 mb-2">$199</p>
                        <p class="text-sm font-medium text-slate-500 mb-6">
                            For operators who audit regularly and hate leaving money behind
                        </p>
                        <ul class="text-left space-y-3 text-sm text-slate-700">
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                <strong>Unlimited</strong> Audits
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                JSON/CSV Claim Export (Mock)
                            </li>
                            <li class="flex items-center">
                                <span class="text-[var(--rh-success)] mr-2 font-bold text-lg">&check;</span>
                                Priority Support
                            </li>
                        </ul>
                    </div>
                    <button
                        onclick="startPurchase('https://buy.stripe.com/bJe3cuarVa2f4Buc2W7EQ00')"
                        class="mt-8 rh-primary-btn w-full text-white p-3 rounded-xl font-bold transition"
                    >
                        Go Pro: Unlock Unlimited Audits
                    </button>
                </div>
            </div>
        </div>
    </section>
    
    <footer class="py-8 bg-[var(--rh-dark)] text-center w-full text-slate-400 mt-10 text-sm">
        <p>© 2025 ClaimPilotPro. Built for serious Amazon FBA sellers.</p>
        <p class="mt-1 text-[11px] text-slate-500">
            ClaimPilotPro is not affiliated with or endorsed by Amazon. Always follow Amazon’s policies when filing claims.
        </p>
    </footer>

    <!-- UPGRADE MODAL -->
    <div
        id="upgrade-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-md w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center">
                <svg
                    id="modal-icon"
                    class="h-12 w-12 text-[var(--rh-primary)] mx-auto mb-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V4m0 16v-4m-6-3H4m16 0h-4"/>
                </svg>
                <h2 id="modal-title" class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">
                    Upgrade Plan
                </h2>
                <p id="modal-price" class="text-4xl font-extrabold text-[var(--rh-success)] mb-4"></p>
                <p id="modal-description" class="text-slate-600 mb-6"></p>
            </div>
            
            <div class="space-y-3">
                <a
                    id="modal-checkout-link"
                    target="_blank"
                    class="rh-primary-btn w-full inline-block text-white p-3 rounded-xl font-semibold text-center transition"
                >
                    Secure Checkout & Unlock Audits
                </a>
                <button
                    onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
                    class="w-full p-3 rounded-xl border border-slate-300 bg-gray-50 hover:bg-gray-100 transition font-medium"
                >
                    Cancel and Go Back
                </button>
            </div>
        </div>
    </div>

    <!-- CLAIM FILING MODAL -->
    <div
        id="claim-filing-modal"
        class="hidden fixed inset-0 bg-black/50 flex justify-center items-start z-50 p-4 overflow-y-auto"
        onclick="closeModalOnOutsideClick(event)"
    >
        <div
            class="bg-white p-8 rounded-2xl max-w-3xl w-full shadow-2xl my-10 relative"
            onclick="event.stopPropagation()"
        >
            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-2 text-[var(--rh-dark)] flex items-center justify-center">
                    <svg
                        class="h-8 w-8 text-[var(--rh-success)] mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9 12l2 2 4-4m5.618-4.27a8.68 8.68 0 00-4.088-3.957A8.68 8.68 0 0012 3a8.68 8.68 0 00-4.53 1.273A8.68 8.68 0 003.382 7.73 8.68 8.68 0 003 12a8.68 8.68 0 001.273 4.53 8.68 8.68 0 003.957 4.088A8.68 8.68 0 0012 21a8.68 8.68 0 004.53-1.273 8.68 8.68 0 004.088-3.957A8.68 8.68 0 0021 12a8.68 8.68 0 00-1.273-4.53z"/>
                    </svg>
                    Claim Filing Guide: Get Reimbursed
                </h2>
                <p class="text-xl text-slate-600">
                    You are about to file
                    <span id="filing-claim-count" class="font-bold text-[var(--rh-primary)]"></span>
                    claims worth
                    <span id="filing-claim-value" class="font-bold text-[var(--rh-success)]"></span>.
                </p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 1: Copy Claim Data (JSON)
                    </h3>
                    <p class="text-sm text-slate-600 mb-2">
                        Use this structured data to reference SKU, quantity, and transaction IDs clearly in your Amazon case.
                    </p>

                    <div class="bg-slate-900 text-emerald-400 p-4 rounded-lg relative">
                        <pre id="claim-json-data" class="text-xs"></pre>
                        <button
                            onclick="copyClaimData()"
                            class="absolute top-2 right-2 p-2 bg-slate-700 rounded-lg text-white hover:bg-slate-600 transition text-xs font-medium"
                        >
                            <span id="copy-btn-text">Copy JSON</span>
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                        Step 2: File on Seller Central
                    </h3>
                    <ol class="list-decimal list-inside space-y-3 text-sm text-slate-700">
                        <li>
                            Go to <strong>Seller Central Help</strong> →
                            <a
                                href="https://sellercentral.amazon.com/gp/contact-us/performance/ref=ag_contactus_foot_perfd_cont_201642190"
                                target="_blank"
                                class="text-teal-700 hover:underline font-medium"
                            >
                                Contact Us
                            </a>
                        </li>
                        <li>Select “Selling on Amazon Issue” → “FBA Issue” → <strong>Investigate Missing / Damaged Units</strong>.</li>
                        <li>Paste the JSON directly into the case description and reference the attached CSV.</li>
                        <li>Attach the original CSV and any supporting screenshots.</li>
                        <li>Submit the case and monitor reimbursements in your Amazon payments reports.</li>
                    </ol>
                </div>
            </div>

            <div class="mt-10">
                <h3 class="text-xl font-bold mb-3 text-[var(--rh-dark)] border-b pb-2">
                    Step 3: Copy/Paste Ready-Made Amazon Case Messages
                </h3>

                <p class="text-sm text-slate-600 mb-4">
                    ClaimPilotPro can generate case-ready language for each claim. Paste these into Seller Central
                    and tweak details as needed.
                </p>

                <div
                    id="claim-messages"
                    class="space-y-4 max-h-64 overflow-y-auto text-left bg-gray-50 p-4 rounded-xl border border-gray-200"
                ></div>
            </div>

            <button
                onclick="document.getElementById('claim-filing-modal').classList.add('hidden')"
                class="rh-primary-btn mt-10 w-full py-3 text-white rounded-xl font-bold shadow-lg transition"
            >
                I Understand – Close Guide
            </button>
        </div>
    </div>

    <!-- AUTH MODALS -->
    <div id="auth-overlay"
         class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 p-4"
         onclick="closeModalOnOutsideClick(event)">
        
        <div id="login-modal"
             class="hidden bg-white p-8 rounded-2xl max-w-md w-full shadow-xl relative"
             onclick="event.stopPropagation()">

            <button
                onclick="closeAuthModals()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                ✕
            </button>

            <h2 class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">Log In</h2>
            <p class="text-sm text-gray-600 mb-6">Access your ClaimPilotPro dashboard</p>

            <input id="login-email"
                   type="email"
                   placeholder="Email"
                   class="w-full mb-3 p-3 rounded-lg border border-gray-300 rh-focus">

            <input id="login-password"
                   type="password"
                   placeholder="Password"
                   class="w-full mb-4 p-3 rounded-lg border border-gray-300 rh-focus">

            <button onclick="loginUser()"
                    class="rh-primary-btn w-full py-3 text-white rounded-xl font-bold">
                Log In
            </button>

            <p class="text-sm mt-4 text-center text-gray-500">
                Need an account?
                <span onclick="switchToSignup()"
                    class="text-[var(--rh-primary)] font-semibold cursor-pointer">
                    Create one
                </span>
            </p>
        </div>

        <div id="signup-modal"
             class="hidden bg-white p-8 rounded-2xl max-w-md w-full shadow-xl relative"
             onclick="event.stopPropagation()">

            <button
                onclick="closeAuthModals()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                ✕
            </button>

            <h2 class="text-2xl font-bold mb-2 text-[var(--rh-dark)]">Create Account</h2>
            <p class="text-sm text-gray-600 mb-6">Start recovering missed FBA reimbursements</p>

            <input id="signup-email"
                   type="email"
                   placeholder="Email"
                   class="w-full mb-3 p-3 rounded-lg border border-gray-300 rh-focus">

            <input id="signup-password"
                   type="password"
                   placeholder="Password"
                   class="w-full mb-4 p-3 rounded-lg border border-gray-300 rh-focus">

            <button onclick="signupUser()"
                    class="rh-primary-btn w-full py-3 text-white rounded-xl font-bold">
                Create Account
            </button>

            <p class="text-sm mt-4 text-center text-gray-500">
                Already have an account?
                <span onclick="switchToLogin()"
                    class="text-[var(--rh-primary)] font-semibold cursor-pointer">
                    Log in
                </span>
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            onSnapshot,
            collection,
            query,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================
        //  CONSTANTS & GLOBAL STATE
        // ============================
        const AUDIT_LIMIT = 5;
        const LOCAL_USAGE_PREFIX = "claimpilot_audits_used_";

        let db, auth;
        let userId = null;
        let auditsUsed = 0;
        let isPremium = false;
        let isAuthReady = false;

        let uploadedFileContent = null;
        let selectedFileName = "";
        let currentClaimsData = [];
        let currentTotalValue = 0;
        let currentClaimMessages = [];
        let lastClaimsData = null;

        const API_BASE_URL = "https://refundhunter-backend.onrender.com";
        const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";

        const firebaseConfig = {
            apiKey: "AIzaSyAwPijZtG54zmRN_vfdFwF_aURZiYJR58s",
            authDomain: "fbamoneyscout.firebaseapp.com",
            projectId: "fbamoneyscout-e0487",
            storageBucket: "fbamoneyscout.firebasestorage.app",
            messagingSenderId: "1072177597124",
            appId: "1:1072177597124:web:bee84507aa63dd827f9791"
        };

        // ============================
        //  LOCAL STORAGE HELPERS
        // ============================
        function loadLocalAuditUsage(uid) {
            try {
                const raw = localStorage.getItem(\`\${LOCAL_USAGE_PREFIX}\${uid}\`);
                const n = parseInt(raw, 10);
                return Number.isFinite(n) && n >= 0 ? n : 0;
            } catch (_) {
                return 0;
            }
        }

        function saveLocalAuditUsage(uid, used) {
            try {
                localStorage.setItem(\`\${LOCAL_USAGE_PREFIX}\${uid}\`, String(used));
            } catch (e) {
                console.warn("Failed to persist usage locally:", e);
            }
        }

        // ============================
        //  FIREBASE INIT
        // ============================
        const firebaseApp = initializeApp(firebaseConfig);
        auth = getAuth(firebaseApp);
        db = getFirestore(firebaseApp);

        // -------------------------
        // STRIPE PURCHASE HANDLER
        // -------------------------
        window.startPurchase = function (stripeLink) {
            if (!auth.currentUser) {
                alert("Please log in first to upgrade.");
                return;
            }

            const uid = auth.currentUser.uid;

            // Attach Firebase UID → Stripe Payment Link → Webhook → Firestore upgrade
            const checkoutUrl = \`\${stripeLink}?client_reference_id=\${encodeURIComponent(uid)}\`;

            console.log("Redirecting to Stripe checkout:", checkoutUrl);
            window.location.href = checkoutUrl;
        };

        // ============================
        //  AUTH MODAL HANDLERS (GLOBAL)
        // ============================
        window.openLoginModal = function () {
            document.getElementById("auth-overlay").classList.remove("hidden");
            document.getElementById("login-modal").classList.remove("hidden");
            document.getElementById("signup-modal").classList.add("hidden");
        };

        window.openSignupModal = function () {
            document.getElementById("auth-overlay").classList.remove("hidden");
            document.getElementById("signup-modal").classList.remove("hidden");
            document.getElementById("login-modal").classList.add("hidden");
        };

        window.switchToSignup = function () {
            document.getElementById("login-modal").classList.add("hidden");
            document.getElementById("signup-modal").classList.remove("hidden");
        };

        window.switchToLogin = function () {
            document.getElementById("signup-modal").classList.add("hidden");
            document.getElementById("login-modal").classList.remove("hidden");
        };

        window.closeAuthModals = function () {
            document.getElementById("auth-overlay").classList.add("hidden");
            document.getElementById("login-modal").classList.add("hidden");
            document.getElementById("signup-modal").classList.add("hidden");
        };

        // Close any modal when clicking the dark backdrop
        window.closeModalOnOutsideClick = function (event) {
            const id = event.target.id;
            if (id === "auth-overlay" || id === "upgrade-modal" || id === "claim-filing-modal") {
                document.getElementById(id).classList.add("hidden");
            }
        };

        // ============================
        //  AUTH ACTIONS
        // ============================
        window.loginUser = async function () {
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value.trim();

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeAuthModals();
            } catch (err) {
                alert("Login failed: " + err.message);
            }
        };

        window.signupUser = async function () {
            const email = document.getElementById("signup-email").value.trim();
            const password = document.getElementById("signup-password").value.trim();

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                closeAuthModals();
            } catch (err) {
                alert("Signup failed: " + err.message);
            }
        };

        window.logoutUser = async function () {
            try {
                await signOut(auth);
                userId = null;
                auditsUsed = 0;
                isPremium = false;
                updateAuditButton();
                updateProfileDisplay();
            } catch (err) {
                alert("Logout failed: " + err.message);
            }
        };

        function initFirebase() {
            try {
                console.log("Firebase Init: App ID =", appId);
                console.log("Firebase Init: Auth ready =", !!auth);
                console.log("Firebase Init: DB ready =", !!db);

                onAuthStateChanged(auth, async (user) => {
                    const loginBtn = document.getElementById("nav-login-btn");
                    const logoutBtn = document.getElementById("nav-logout-btn");

                    if (user) {
                        userId = user.uid;
                        // Load local usage immediately so UI updates even if Firestore is grumpy
                        auditsUsed = loadLocalAuditUsage(userId);
                        if (loginBtn) loginBtn.classList.add("hidden");
                        if (logoutBtn) logoutBtn.classList.remove("hidden");
                        updateAuditButton();
                        updateProfileDisplay();

                        if (!isAuthReady) {
                            isAuthReady = true;
                            loadUserDataAndHistory();
                        }
                    } else {
                        userId = null;
                        auditsUsed = 0;
                        isPremium = false;
                        if (loginBtn) loginBtn.classList.remove("hidden");
                        if (logoutBtn) logoutBtn.classList.add("hidden");
                        updateAuditButton();
                        updateProfileDisplay();
                    }
                });
            } catch (e) {
                console.error("Firebase init failed:", e);
                alert("Firebase failed to initialize. Check your configuration.");
            }
        }

        // ============================
        //  USER DATA + HISTORY (FIRESTORE)
        // ============================
        function getLimitsDocRef() {
            const uid = auth.currentUser?.uid || userId;
            if (!uid) return null;
            return doc(
                db,
                "artifacts",
                "fbamoneyscout",
                "users",
                uid,
                "user_data",
                "limits"
            );
        }

        function getHistoryCollectionRef() {
            const uid = auth.currentUser?.uid || userId;
            if (!uid) return null;
            return collection(
                db,
                "artifacts",
                "fbamoneyscout",
                "users",
                uid,
                "user_data",
                "audit_history"
            );
        }

        function loadUserDataAndHistory() {
            if (!db || !userId) return;
            console.log("Loading user data and history for user:", userId);

            const limitsDocRef = getLimitsDocRef();
            if (!limitsDocRef) return;

            // Limits doc listener (to sync isPremium + cloud usage)
            onSnapshot(
                limitsDocRef,
                (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const cloudUsed = typeof data.auditsUsed === "number" ? data.auditsUsed : 0;
                        const localUsed = loadLocalAuditUsage(userId);

                        // Prefer the max so we never "lose" used count
                        const finalUsed = Math.max(cloudUsed, localUsed);
                        auditsUsed = finalUsed;
                        saveLocalAuditUsage(userId, finalUsed);

                        isPremium = !!data.isPremium;
                    } else {
                        // If doc doesn't exist, initialize it with our current local usage
                        const startingUsed = loadLocalAuditUsage(userId);
                        auditsUsed = startingUsed;
                        setDoc(
                            limitsDocRef,
                            { auditsUsed: startingUsed, isPremium: false },
                            { merge: true }
                        ).catch(console.error);
                    }
                    updateAuditButton();
                    updateProfileDisplay();
                },
                (error) => {
                    console.error("Error reading limits:", error);
                    document.getElementById("status-message").textContent =
                        "Error reading free uses limit (using local counter only).";
                    // We still continue with local usage
                    auditsUsed = loadLocalAuditUsage(userId);
                    updateAuditButton();
                    updateProfileDisplay();
                }
            );

            // History
            const historyCollectionRef = getHistoryCollectionRef();
            if (!historyCollectionRef) return;

            const historyQuery = query(historyCollectionRef, orderBy("createdAt", "desc"));

            onSnapshot(
                historyQuery,
                (snapshot) => {
                    console.log("History snapshot received. Documents:", snapshot.docs.length);
                    renderHistory(snapshot.docs);
                },
                (error) => {
                    console.error("Error reading history:", error);
                    document.getElementById("history-loading").textContent =
                        "Error loading history.";
                }
            );
        }

        async function saveAuditResult(fileName, claims, totalValue) {
            if (!db || !userId) return;

            try {
                const historyCollectionRef = getHistoryCollectionRef();
                if (!historyCollectionRef) return;

                await setDoc(doc(historyCollectionRef), {
                    fileName: fileName,
                    claimsCount: claims.length,
                    totalEstimatedValue: totalValue,
                    claims: JSON.stringify(claims),
                    createdAt: serverTimestamp()
                });

                console.log("Audit result saved successfully.");
            } catch (error) {
                console.error("Failed to save audit result:", error);
                document.getElementById("status-message").textContent =
                    "Audit saved locally but failed to save to history.";
            }
        }

        // 🚀 LOCAL-FIRST COUNTER (then sync to Firestore best-effort)
        async function incrementAuditCounter() {
            const uid = auth.currentUser?.uid || userId;
            if (!uid) {
                console.error("No user ID for incrementAuditCounter");
                return false;
            }

            // 1) Local first (this is what drives the UI)
            let newCount = (auditsUsed || 0) + 1;
            auditsUsed = newCount;
            saveLocalAuditUsage(uid, newCount);
            updateAuditButton();
            updateProfileDisplay();

            // 2) Firestore best-effort sync
            try {
                const limitsDocRef = getLimitsDocRef();
                if (!limitsDocRef) return true;

                await setDoc(
                    limitsDocRef,
                    { auditsUsed: newCount },
                    { merge: true }
                );
            } catch (error) {
                console.error("Firestore sync failed (incrementAuditCounter):", error);
                document.getElementById("status-message").textContent =
                    "Usage tracked locally. Sync issue with server.";
            }

            return true;
        }

        function updateProfileDisplay() {
            try {
                const auditsUsedEl = document.getElementById("audits-used");
                const auditsRemainingEl = document.getElementById("audits-remaining");
                const usageBarEl = document.getElementById("usage-bar");
                const subscriptionStatusEl = document.getElementById("subscription-status");

                const used = auditsUsed || 0;
                const remaining = Math.max(AUDIT_LIMIT - used, 0);
                const isPro = !!isPremium;

                if (auditsUsedEl) auditsUsedEl.textContent = used;
                if (auditsRemainingEl) auditsRemainingEl.textContent = isPro ? "∞" : remaining;

                if (usageBarEl) {
                    const pct = isPro ? 100 : Math.min((used / AUDIT_LIMIT) * 100, 100);
                    usageBarEl.style.width = pct + "%";
                }

                if (subscriptionStatusEl) {
                    subscriptionStatusEl.textContent = isPro
                        ? "ClaimPilotPro – Unlimited"
                        : "Trial User";
                }
            } catch (err) {
                console.error("updateProfileDisplay failed:", err);
            }
        }

        function renderHistory(docs) {
            const listContainer = document.getElementById("history-list");
            listContainer.innerHTML = "";
            document.getElementById("history-loading").classList.add("hidden");

            if (docs.length === 0) {
                listContainer.innerHTML =
                    '<p class="text-slate-500 italic">No previous audits found. Upload your first report to see results here.</p>';
                return;
            }

            docs.forEach((docSnap) => {
                const data = docSnap.data();
                const date = data.createdAt
                    ? new Date(data.createdAt.seconds * 1000).toLocaleDateString("en-US", {
                          year: "numeric",
                          month: "short",
                          day: "numeric"
                      })
                    : "N/A";

                const historyItem = document.createElement("div");
                historyItem.className =
                    "bg-white p-4 rounded-xl shadow border border-gray-200 flex justify-between items-center hover:shadow-lg transition cursor-pointer";
                historyItem.onclick = () => viewHistoryItem(docSnap.id);

                historyItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${data.fileName || "Audit Report"}</p>
                        <p class="text-sm text-slate-600">
                            Audited on ${date} &bull; ${data.claimsCount} claims found
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-extrabold text-[var(--rh-success)]">
                            $${(data.totalEstimatedValue || 0).toFixed(2)}
                        </p>
                        <span class="text-xs text-[var(--rh-primary)] hover:underline mt-1">
                            View Details
                        </span>
                    </div>
                `;
                listContainer.appendChild(historyItem);
            });
        }

        window.viewHistoryItem = function (docId) {
            const uid = auth.currentUser?.uid || userId;
            if (!uid) return;

            const docRef = doc(
                db,
                "artifacts",
                "fbamoneyscout",
                "users",
                uid,
                "user_data",
                "audit_history",
                docId
            );

            onSnapshot(
                docRef,
                (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const claims = JSON.parse(data.claims || "[]");

                        currentClaimsData = claims;
                        currentTotalValue = data.totalEstimatedValue || 0;

                        displayClaims(claims, currentTotalValue, data.fileName || "Audit Report");
                    }
                },
                (error) => {
                    console.error("Failed to load history item:", error);
                    document.getElementById("status-message").textContent =
                        "Failed to load audit details.";
                }
            );
        };

        // ============================
        //  FILE UPLOAD (LOGIN-GATED)
        // ============================
        // Require login before letting user pick a file
        window.requireLoginThenSelectFile = function (event) {
            if (!auth.currentUser) {
                event.target.value = null;
                openLoginModal();
                return;
            }
            handleFileSelect(event);
        };

        // STREAMING FILE READER (better for big CSVs)
        window.handleFileSelect = async function (event) {
            console.log("File select triggered");

            const file = event.target.files[0];
            const fileNameDisplay = document.getElementById("file-name-display");

            document.getElementById("results-area").classList.add("hidden");

            if (!file) {
                uploadedFileContent = null;
                fileNameDisplay.textContent = "No file selected.";
                updateAuditButton();
                return;
            }

            if (file.type !== "text/csv" && !file.name.endsWith(".csv")) {
                fileNameDisplay.textContent = "Error: Please upload a .csv file only.";
                fileNameDisplay.classList.add("text-red-500");
                uploadedFileContent = null;
                updateAuditButton();
                return;
            }

            selectedFileName = file.name;
            fileNameDisplay.textContent = \`File Selected: \${selectedFileName}\`;
            fileNameDisplay.classList.remove("text-red-500");

            try {
                uploadedFileContent = "";

                const decoder = new TextDecoder("utf-8");
                const reader = file.stream().getReader();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    uploadedFileContent += decoder.decode(value, { stream: true });
                }

                // finalize decoding
                uploadedFileContent += decoder.decode();
                updateAuditButton();
            } catch (e) {
                console.error("File streaming error", e);
                uploadedFileContent = null;
                fileNameDisplay.textContent = "Error reading file.";
                fileNameDisplay.classList.add("text-red-500");
                updateAuditButton();
            }
        };

        // ============================
        //  AUDIT BUTTON / STATE
        // ============================
        function updateAuditButton() {
            const auditButton = document.getElementById("audit-button");
            const freeUsesDisplay = document.getElementById("free-uses-display");
            if (!auditButton) return;

            const used = auditsUsed || 0;
            const remaining = Math.max(AUDIT_LIMIT - used, 0);
            const isFileReady = uploadedFileContent !== null;
            const loggedIn = !!(auth.currentUser || userId);

            auditButton.onclick = null;

            // Not logged in
            if (!loggedIn) {
                auditButton.textContent = "Log in to run an audit";
                auditButton.disabled = false;
                auditButton.onclick = openLoginModal;
                if (freeUsesDisplay) {
                    freeUsesDisplay.innerHTML = `
                        Your first <strong>${AUDIT_LIMIT}</strong> ClaimPilotPro audits are free.
                        Log in to start using them.
                    `;
                }
                return;
            }

            if (isPremium) {
                auditButton.textContent = "Run Audit (ClaimPilotPro Unlimited)";
                auditButton.disabled = !isFileReady;

                if (isFileReady) {
                    auditButton.onclick = processAuditWrapper;
                }

                if (freeUsesDisplay) {
                    freeUsesDisplay.innerHTML =
                        'You are on <strong>ClaimPilotPro Monthly</strong>. Unlimited audits unlocked.';
                }

                return;
            }

            // Free tier
            if (remaining > 0) {
                auditButton.textContent = `Audit Report (${remaining}/${AUDIT_LIMIT} FREE Uses Remaining)`;
                auditButton.disabled = !isFileReady;

                if (isFileReady) {
                    auditButton.onclick = processAuditWrapper;
                }

                if (freeUsesDisplay) {
                    freeUsesDisplay.innerHTML = `
                        Your first <strong>${AUDIT_LIMIT}</strong> ClaimPilotPro audits are free.
                        You have <strong>${remaining}</strong> remaining.
                    `;
                }

                return;
            }

            // Free limit exceeded
            auditButton.textContent = "Audit Report (Upgrade Required)";
            auditButton.disabled = false;
            auditButton.onclick = () => showUpgradeModal("audit_monthly");

            if (freeUsesDisplay) {
                freeUsesDisplay.innerHTML = `
                    You have used your <strong>${AUDIT_LIMIT}</strong> free audits.
                    Upgrade to ClaimPilotPro Monthly for unlimited audits.
                `;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            initFirebase();
            const auditButton = document.getElementById("audit-button");
            if (auditButton) {
                auditButton.onclick = processAuditWrapper;
            }
        });

        function processAuditWrapper() {
            if (!auth.currentUser && !userId) {
                openLoginModal();
                return;
            }

            if (!isPremium && (auditsUsed || 0) >= AUDIT_LIMIT) {
                showUpgradeModal("audit_monthly");
                return;
            }

            if (uploadedFileContent) {
                processAudit(uploadedFileContent, selectedFileName);
            }
        }

        function finishAuditDisplay() {
            document.getElementById("loading-indicator").classList.add("hidden");
            document.getElementById("upload-section").classList.remove("hidden");

            displayClaims(currentClaimsData, currentTotalValue, selectedFileName || "Audit Report");

            uploadedFileContent = null;
            selectedFileName = "";
            document.getElementById("file-name-display").textContent =
                "Click to upload your FBA Inventory Ledger or Daily Inventory History report (.csv)";
            document.getElementById("csv-file").value = "";
            document.getElementById("audit-button").disabled = true;

            document.getElementById("status-message").textContent =
                "Audit complete. Ready for your next report.";
        }

        // ============================
        //  UPGRADE / CLAIM MODALS
        // ============================
        window.showUpgradeModal = function (productName) {
            const modal = document.getElementById("upgrade-modal");
            const title = document.getElementById("modal-title");
            const price = document.getElementById("modal-price");
            const description = document.getElementById("modal-description");
            const checkoutLink = document.getElementById("modal-checkout-link");
            const modalIconPath = modal.querySelector("#modal-icon path");

            const productDetails =
                {
                    audit_monthly: {
                        title: "Unlock ClaimPilotPro Unlimited",
                        price: "$199 / Month",
                        description:
                            "Upgrade to ClaimPilotPro Monthly to run unlimited FBA reimbursement audits and never leave easy money behind.",
                        iconPath:
                            "M12 1c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zM10 13l2-2 2 2M10 11l2-2 2 2",
                        url: `https://buy.stripe.com/bJe3cuarVa2f4Buc2W7EQ00`
                    },
                    audit_single: {
                        title: "Purchase Single Audit Boost",
                        price: "$99 One-Time",
                        description:
                            "Grab a single ClaimPilotPro audit for a key reporting period without committing to a subscription.",
                        iconPath: "M12 6v6m0 0v6m0-6h6m-6 0H6",
                        url: `https://buy.stripe.com/28EbJ0bvZ0rF4BuaYS7EQ01`
                    }
                }[productName] || null;

            if (!productDetails) return;

            title.textContent = productDetails.title;
            price.textContent = productDetails.price;
            description.textContent = productDetails.description;
            checkoutLink.href = productDetails.url;

            // Make the CTA use startPurchase so we always send Firebase UID to Stripe
            checkoutLink.onclick = (e) => {
                e.preventDefault();
                window.startPurchase(productDetails.url);
            };

            if (modalIconPath) {
                modalIconPath.setAttribute("d", productDetails.iconPath);
            }

            modal.classList.remove("hidden");
        };

        window.showClaimFilingModal = function (claims, totalValue) {
            const modal = document.getElementById("claim-filing-modal");
            const claimCountDisplay = document.getElementById("filing-claim-count");
            const claimValueDisplay = document.getElementById("filing-claim-value");
            const jsonDataBlock = document.getElementById("claim-json-data");
            const copyBtnText = document.getElementById("copy-btn-text");
            const messagesContainer = document.getElementById("claim-messages");

            claimCountDisplay.textContent = \`\${claims.length}\`;
            claimValueDisplay.textContent = \`$\${totalValue.toFixed(2)}\`;

            const jsonClaims = JSON.stringify(claims, null, 2);
            jsonDataBlock.textContent = jsonClaims;

            copyBtnText.textContent = "Copy JSON";

            if (messagesContainer) {
                messagesContainer.innerHTML = "";

                if (!currentClaimMessages || currentClaimMessages.length === 0) {
                    messagesContainer.innerHTML =
                        "<p class='text-sm text-slate-500 italic'>No pre-written messages were generated for this audit. You can still use the JSON and steps above to file your claims.</p>";
                } else {
                    currentClaimMessages.forEach((msg, index) => {
                        const card = document.createElement("div");
                        card.className =
                            "bg-gray-50 border border-gray-200 rounded-lg p-3";

                        const skuLabel = msg.sku ? \`SKU: \${msg.sku}\` : "";
                        const reasonLabel = msg.reason ? \`Reason: \${msg.reason}\` : "";

                        card.innerHTML = `
                          <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-slate-800">
                              Case Message #${index + 1}
                            </span>
                            <span class="text-xs text-slate-500">
                              ${skuLabel}
                              ${reasonLabel ? "&nbsp;&bull;&nbsp;" + reasonLabel : ""}
                            </span>
                          </div>
                          <textarea
                            class="w-full text-xs p-2 rounded-md border border-gray-300 bg-white"
                            rows="5"
                            readonly
                          >${(msg.message || "").trim()}</textarea>
                        `;

                        messagesContainer.appendChild(card);
                    });
                }
            }

            modal.classList.remove("hidden");
        };

        window.copyClaimData = function () {
            const jsonDataBlock = document.getElementById("claim-json-data");
            const copyBtnText = document.getElementById("copy-btn-text");

            try {
                const tempTextArea = document.createElement("textarea");
                tempTextArea.value = jsonDataBlock.textContent;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand("copy");
                document.body.removeChild(tempTextArea);

                copyBtnText.textContent = "Copied!";
                setTimeout(() => {
                    copyBtnText.textContent = "Copy JSON";
                }, 2000);
            } catch (err) {
                console.error("Failed to copy text: ", err);
                copyBtnText.textContent = "Error Copying!";
            }
        };

        // ============================
        //  BACKEND AUDIT CALL
        // ============================
        async function processAudit(csvContent, fileName) {
            if (!isPremium && (auditsUsed || 0) >= AUDIT_LIMIT) {
                showUpgradeModal("audit_monthly");
                return;
            }

            document.getElementById("upload-section").classList.add("hidden");
            document.getElementById("loading-indicator").classList.remove("hidden");
            document.getElementById("results-area").classList.add("hidden");
            document.getElementById("status-message").textContent =
                \`Analyzing \${fileName}...\`;

            try {
                const response = await fetch(\`\${API_BASE_URL}/api/audit\`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        csvContent,
                        fileName,
                        userId: (auth.currentUser && auth.currentUser.uid) || userId || "anonymous"
                    })
                });

                if (!response.ok) {
                    throw new Error(\`Backend responded with status \${response.status}\`);
                }

                const data = await response.json();

                currentClaimsData = data.claims || [];
                currentTotalValue = data.totalEstimatedValue || 0;
                currentClaimMessages = data.messages || [];

                if (!isPremium) {
                    await incrementAuditCounter();
                }
                await saveAuditResult(fileName, currentClaimsData, currentTotalValue);
            } catch (err) {
                console.error("BACKEND ERROR:", err);
                alert("Error analyzing your report. If the file is extremely large, try a smaller date range and re-upload.");

                currentClaimsData = [];
                currentTotalValue = 0;

                document.getElementById("loading-indicator").classList.add("hidden");
                document.getElementById("upload-section").classList.remove("hidden");
                document.getElementById("status-message").textContent =
                    "Audit failed: connection or server error.";
                return;
            }

            finishAuditDisplay();
        }

        // ============================
        //  CHART + CLAIM DISPLAY
        // ============================
        function renderClaimChart(data, total) {
            const canvas = document.getElementById("claim-chart");
            const ctx = canvas.getContext("2d");

            lastClaimsData = { data, total };

            canvas.width = canvas.offsetWidth;
            canvas.height = 250;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (total === 0 || !Object.keys(data).length) {
                ctx.fillStyle = "#94a3b8";
                ctx.font = "16px Inter";
                ctx.textAlign = "center";
                ctx.fillText("No claims found to chart.", canvas.width / 2, canvas.height / 2);
                return;
            }

            const reasons = Object.keys(data);
            const values = Object.values(data);
            const numBars = reasons.length;

            const colors = ["#0F766E", "#22C55E", "#0EA5E9", "#F97316", "#6366F1", "#E11D48"];
            const darkText = "#0f172a";
            const lightGrey = "#e5e7eb";

            const padding = 30;
            const chartHeight = canvas.height - padding * 2;
            const chartWidth = canvas.width - padding * 2;
            const barSpacing = 15;
            const barWidth = (chartWidth - (numBars - 1) * barSpacing) / numBars;
            const maxValue = Math.max(...values) * 1.1;

            ctx.strokeStyle = lightGrey;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            for (let i = 0; i < numBars; i++) {
                const value = values[i];
                const reason = reasons[i];
                const x = padding + i * (barWidth + barSpacing);
                const barHeight = (value / maxValue) * chartHeight;
                const y = canvas.height - padding - barHeight;
                const barXCenter = x + barWidth / 2;

                ctx.fillStyle = colors[i % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);

                ctx.fillStyle = darkText;
                ctx.font = "11px Inter";
                ctx.textAlign = "center";
                ctx.fillText(reason, barXCenter, canvas.height - 10);

                ctx.fillStyle = darkText;
                ctx.font = "14px Inter bold";
                ctx.fillText(\`$\${value.toFixed(0)}\`, barXCenter, y - 5);
            }
        }

        window.addEventListener("resize", () => {
            const resultsArea = document.getElementById("results-area");
            if (!resultsArea.classList.contains("hidden") && lastClaimsData) {
                renderClaimChart(lastClaimsData.data, lastClaimsData.total);
            }
        });

        function displayClaims(claims, totalEstimatedValue, auditFileName) {
            const resultsArea = document.getElementById("results-area");
            const listContainer = document.getElementById("claim-list");
            const claimCountDisplay = document.getElementById("claim-count");
            const noClaimsMessage = document.getElementById("no-claims-found");

            resultsArea.classList.remove("hidden");
            resultsArea.querySelector("h2").innerHTML = `
                <span id="claim-count" class="text-4xl text-[var(--rh-success)] mr-4">
                    ${claims.length}
                </span>
                Actionable Reimbursement Claims Found in: ${auditFileName}
            `;

            listContainer.innerHTML = "";
            const valueByReason = {};

            if (claims && claims.length > 0) {
                claimCountDisplay.textContent = claims.length;
                noClaimsMessage.classList.add("hidden");

                claims.forEach((claim) => {
                    const value = parseFloat(claim.estimatedValue) || 0;
                    const reason = claim.claimReason || "Unspecified Claim";

                    valueByReason[reason] = (valueByReason[reason] || 0) + value;

                    const claimElement = document.createElement("div");
                    claimElement.className =
                        "bg-gray-50 p-4 rounded-xl border border-gray-200 hover:bg-gray-100 transition";
                    claimElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-bold text-slate-800">${reason}</span>
                            <span class="text-xl font-extrabold text-[var(--rh-success)]">
                                $${value.toFixed(2)}
                            </span>
                        </div>
                        <p class="text-sm text-slate-600">
                            <strong>SKU:</strong> ${claim.sku || "N/A"} &bull;
                            <strong>Qty:</strong> ${claim.quantity || 1} &bull;
                            <strong>Ref ID:</strong> ${claim.amazonTransactionId || "None"}
                        </p>
                    `;
                    listContainer.appendChild(claimElement);
                });

                renderClaimChart(valueByReason, totalEstimatedValue);

                const summaryElement = document.createElement("div");
                summaryElement.className =
                    "bg-white p-6 rounded-xl border-4 border-[var(--rh-primary)] shadow-inner mb-6";
                summaryElement.innerHTML = `
                    <p class="text-xl font-bold text-[var(--rh-dark)] flex justify-between">
                        <span>Total Estimated Reimbursement Value:</span> 
                        <span class="text-3xl text-[var(--rh-success)] font-extrabold">
                            $${totalEstimatedValue.toFixed(2)}
                        </span>
                    </p>
                    <p class="text-sm text-slate-500 mt-2">
                        This is the cash you can potentially recover by filing these claims through Amazon Seller Central.
                    </p>
                `;
                listContainer.prepend(summaryElement);

                const fileClaimsButton = document.createElement("button");
                fileClaimsButton.id = "file-claims-btn";
                fileClaimsButton.className =
                    "rh-primary-btn mt-6 w-full py-3 text-white rounded-xl font-bold shadow-lg transition";
                fileClaimsButton.textContent = `File ${claims.length} Claims Worth $${totalEstimatedValue.toFixed(2)}`;
                fileClaimsButton.onclick = () =>
                    showClaimFilingModal(currentClaimsData, currentTotalValue);

                listContainer.appendChild(fileClaimsButton);
            } else {
                claimCountDisplay.textContent = "0";
                noClaimsMessage.classList.remove("hidden");
                renderClaimChart({}, 0);
            }
        }
    </script>
</body>
</html>
